template:
  inputs:
    connector:
      type: connector
      label: AWS connector
      required: true
      oneof:
        - Aws
      ui:
        tooltip: The Harness AWS Connector for the AWS account where you want perform ECS Bluegreen deployment
        placeholder: Select AWS Connector
    cluster:
      type: string
      label: Cluster
      required: true
      default: ${{infra.cluster}}
      ui:
        component: string
        tooltip: The AWS cluster
    region:
      type: string
      label: Region
      required: true
      default: ${{infra.region}}
      ui:
        component: string
        placeholder: us-east-1
        tooltip: The AWS region
    log_level:
      type: string
      label: Log level
      default: info
      options:
        - warn
        - error
        - info
        - debug
        - trace
      ui:
        component: select
        tooltip: Set the log level for the step
    task_def_mode:
      type: string
      label: Task definition
      default: Task Definition
      required: true
      options:
        - Task Definition
        - Task Definition ARN
      ui:
        component: select
    task_def:
      type: string
      label: ECS task definition
      required: true
      default: ${{service.manifests.taskDefinition.paths}}
      ui:
        component: string
        tooltip: Path to the file containing task definition
        placeholder: /path/to/file
        visible: ${{taskDefMode == 'Task Definition'}}
    task_def_arn:
      type: string
      label: ECS task definition ARN
      required: true
      default: ${{service.taskArn}}
      ui:
        component: string
        tooltip: ARN value of task definition
        placeholder: Enter task definition ARN
        visible: ${{taskDefMode == 'Task Definition ARN'}}
    service_def:
      type: string
      label: ECS service definition
      required: true
      default: ${{service.manifests.serviceDefinition.paths}}
      ui:
        component: string
        tooltip: Path to the file containing service definition
        placeholder: /path/to/file
    scalable_targets:
      type: array
      label: ECS scalable targets
      default: ${{service.manifests.scalableTarget.paths}}
      ui:
        component: array
        input:
          inputType: text
        tooltip: Path to the file(s) containing scalable target definition
        placeholder: /path/to/file
    scaling_policies:
      type: array
      label: ECS scaling policies
      default: ${{service.manifests.scalingPolicy.paths}}
      ui:
        component: array
        input:
          inputType: text
        tooltip: Path to the file(s) containing scaling policies definition
        placeholder: /path/to/file
    target_group_arn_key:
      type: string
      label: ECS target group ARN key (placeholder)
      default: <+targetGroupArn>
      ui:
        component: string
        tooltip: Placeholder for target group ARN value
    remove_autoscaling_blue_svc:
      type: boolean
      label: Enable Auto Scaling In Swap Step
      default: false
      ui:
        component: boolean-card-select
        tooltip: Remove autoscaling config from blue service
        visible: ${{trafficShift == false}}
    update_green_svc:
      type: boolean
      label: Update green service
      default: false
      ui:
        component: boolean-card-select
        tooltip: Update green service instead of deleting it
    skip_steady_state:
      type: boolean
      label: Skip steady state check
      default: false
      ui:
        component: boolean-card-select
        tooltip: Turn on to skip steady state check 
    steady_state_timeout:
      type: string
      label: Steady state check command timeout
      default: 10m
      ui:
        tooltip: Timeout to use during steady state check process
        visible: ${{skipSteadyState == false}}
    load_balancer:
      type: string
      label: Elastic Load balancer
      required: true
      ui:
        tooltip: Elastic Load balancer
        placeholder: Please enter load balancer name
    traffic_shift:
      type: boolean
      label: Use Shift Traffic
      default: false
      ui:
        component: boolean-card-select
        tooltip: Enable this checkbox to activate traffic shifting for the ECS Blue Green deployment. When selected, traffic will be gradually shifted between target groups based on the weight percentages you define. If not selected, the deployment will follow the standard Blue Green process, swapping traffic 100% between the production and stage target groups.
    prod_listener_arn:
      type: string
      label: Prod listener
      required: true
      ui:
        tooltip: Select the ELB listener that you want to use as the Prod Listener.
        placeholder: Please enter ARN of Prod listener
    prod_listener_rule_arn:
      type: string
      label: Prod listener rule ARN
      ui:
        tooltip: If you do not enter a listener rule, Harness uses the Default rule.
        placeholder: Please enter ARN of Prod listener rule
    stage_listener_arn:
      type: string
      label: Stage listener
      required: true
      ui:
        tooltip: Select the ELB listener that you want to use as the Stage Listener.
        placeholder: Please enter ARN of Stage listener
        visible: ${{trafficShift == false}}
    stage_listener_rule_arn:
      type: string
      label: Stage listener rule ARN
      ui:
        tooltip: If you do not enter a listener rule, Harness uses the Default rule.
        placeholder: Please enter ARN of Stage listener rule
        visible: ${{trafficShift == false}}
    stage_target_group_arn:
      type: string
      label: Stage Target Group ARN
      ui:
        tooltip: Select the target group where the new service version will be deployed.
        placeholder: Please enter Stage Target Group ARN
        visible: ${{trafficShift == true}}
  layout:
    - connector
    - region
    - cluster
    - task_def_mode
    - task_def
    - task_def_arn
    - service_def
    - load_balancer
    - prod_listener_arn
    - stage_listener_arn
    - title: Optional Configuration
      items:
        - scalable_targets
        - scaling_policies
        - prod_listener_rule_arn
        - stage_listener_rule_arn
        - stage_target_group_arn
        - target_group_arn_key
        - steady_state_timeout
        - log_level
        - traffic_shift
        - remove_autoscaling_blue_svc
        - update_green_svc
        - skip_steady_state
  id: ecsBluegreenDeployStep
  name: ECS BlueGreen Deploy Step
  description: Executes an ECS BlueGreen deployment
  version: 1
  author: harness
  module:
    - cd
  alias: bg-deploy
  step:
    group:
      steps:
        - name: bluegreendeploy
          id: bluegreendeploy
          run:
            container:
              image: harnessdev/ecs-bluegreen:0.0.1
              connector: account.harnessImage
            env:
              PLUGIN_HARNESS_CONNECTOR: ${{inputs.connector.id}}
              PLUGIN_LOG_LEVEL: ${{inputs.log_level}}
              PLUGIN_CLUSTER: ${{inputs.cluster}}
              PLUGIN_REGION: ${{inputs.region}}
              PLUGIN_TASK_DEFINITION: ${{inputs.task_def}}
              PLUGIN_SERVICE_DEFINITION: ${{inputs.service_def}}
              PLUGIN_SCALABLE_TARGETS: ${{inputs.scalable_targets}}
              PLUGIN_SCALING_POLICIES: ${{inputs.scaling_policies}}
              PLUGIN_TASK_DEFINITION_ARN: ${{inputs.task_def_arn}}
              PLUGIN_TARGET_GROUP_ARN_KEY: ${{inputs.target_group_arn_key}}
              PLUGIN_MATCH_RUNNING_INSTANCES_COUNT: ${{runtime.ff.CDS_ECS_BG_VALIDATION_WITH_SAME_TARGET_GROUPS}}
              PLUGIN_REMOVE_AUTOSCALING_FROM_BLUE_SVC: ${{inputs.remove_autoscaling_blue_svc}}
              PLUGIN_UPDATE_GREEN_SERVICE: ${{inputs.update_green_svc}}
              PLUGIN_STEADY_STATE_CHECK: ${{inputs.skip_steady_state}}
              PLUGIN_STEADY_STATE_CHECK_TIMEOUT: ${{inputs.steady_state_timeout}}
              PLUGIN_LOAD_BALANCER: ${{inputs.load_balancer}}
              PLUGIN_TRAFFIC_SHIFT: ${{inputs.traffic_shift}}
              PLUGIN_PROD_LISTENER_ARN: ${{inputs.prod_listener_arn}}
              PLUGIN_PROD_LISTENER_RULE_ARN: ${{inputs.prod_listener_rule_arn}}
              PLUGIN_STAGE_LISTENER_ARN: ${{inputs.stage_listener_arn}}
              PLUGIN_STAGE_LISTENER_RULE_ARN: ${{inputs.stage_listener_rule_arn}}
              PLUGIN_STAGE_TARGET_GROUP_ARN_INPUT: ${{inputs.stage_target_group_arn}}