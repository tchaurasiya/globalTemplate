template:
  id: SaveCacheToHarness
  name: SaveCacheToHarness
  version: 1
  inputs:
    connector:
      type: connector
      value: <+runtime.settings.ci_cache_connector>
    cacheKey:
      type: string
      value: <+stage.cacheIntelligence.key>
    endpoint:
      type: string
      value: <+runtime.settings.ci_cache_s3_endpoint_url>
    bucket:
      type: string
      value: <+runtime.settings.ci_cache_s3_bucket_name>
    region:
      type: string
      value: <+runtime.settings.ci_cache_s3_region>
    mount:
      type: string
      value: <+stage.cacheIntelligence.path>
  step:
    group:
      steps:
        - if: <+<+stage.runtime>.cloud == null>
          id: saveCacheToHarness
          name: saveCacheToHarness
          run:
            container:
              image: plugins/cache:1.8.1
            with:
              CACHE_KEY: <+inputs.cacheKey>
              MOUNT: <+inputs.mount>
              REBUILD: true
              ENDPOINT: <+inputs.endpoint>
              REGION: <+inputs.region>
              ARCHIVE_FORMAT: tar
              OVERRIDE: false
              EXIT_CODE: true
              BACKEND: <+runtime.inputs.PLUGIN_BACKEND>
              BACKEND_OPERATION_TIMEOUT: 10000s
              BUCKET: <+inputs.bucket>
              ACCESS_KEY: <+<+inputs.connector>.accessKey>
              SECRET_KEY: <+<+inputs.connector>.secretKey>
          on-failure:
            errors: all
            action: success
        - if: <+<+stage.runtime>.cloud != null>
          id: saveCachetoHarness
          name: saveCachetoHarness
          run:
            container:
              image: plugins/cache
            with:
              CACHE_KEY: <+inputs.cacheKey>
              MOUNT: <+inputs.mount>
              REBUILD: true
              ARCHIVE_FORMAT: tar
              OVERRIDE: false
              EXIT_CODE: true
              BACKEND_OPERATION_TIMEOUT: 10000s
              ACL: private
              AUTO_CACHE: true
          on-failure:
            errors: all
            action: success