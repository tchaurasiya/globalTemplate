template:
  inputs:
    connector:
      type: connector
      label: AWS connector
      required: true
      default: ${{infra.connector}}
      oneof:
        - Aws
      ui:
        tooltip: Select the Harness AWS Connector for the AWS account where you want to perform ECS Bluegreen deployment
        placeholder: Select AWS Connector
    cluster:
      type: string
      label: Cluster
      required: true
      default: ${{infra.cluster}}
      ui:
        component: string
        tooltip: Enter the AWS cluster name where the ECS service is deployed
    region:
      type: string
      label: Region
      required: true
      default: ${{infra.region}}
      ui:
        component: string
        placeholder: us-east-1
        tooltip: Enter the AWS region where the ECS cluster is located
    deploy_log_level:
      type: string
      label: Log level for deploy
      default: info
      options:
        - warn
        - error
        - info
        - debug
        - trace
      ui:
        component: select
        tooltip: Select the log level for the deploy step.
    task_def_mode:
      type: string
      label: Task definition
      default: Task Definition
      required: true
      options:
        - Task Definition
        - Task Definition ARN
      ui:
        component: select
    task_def:
      type: string
      label: ECS task definition
      required: true
      default: ${{service.manifests.taskDefinition.paths}}
      ui:
        component: string
        tooltip: Enter the path to the file containing task definition
        placeholder: /path/to/file
        visible: ${{taskDefMode == 'Task Definition'}}
    task_def_arn:
      type: string
      label: ECS task definition ARN
      required: true
      default: ${{service.taskArn}}
      ui:
        component: string
        tooltip: Enter the ARN value of the task definition
        placeholder: Enter task definition ARN
        visible: ${{taskDefMode == 'Task Definition ARN'}}
    service_def:
      type: string
      label: ECS service definition
      required: true
      default: ${{service.manifests.serviceDefinition.paths}}
      ui:
        component: string
        tooltip: Enter the path to the file containing service definition
        placeholder: /path/to/file
    scalable_targets:
      type: array
      label: ECS scalable targets
      default: ${{service.manifests.scalableTarget.paths}}
      ui:
        component: array
        input:
          inputType: text
        tooltip: Enter the path to the file(s) containing scalable target definition
        placeholder: /path/to/file
    scaling_policies:
      type: array
      label: ECS scaling policies
      default: ${{service.manifests.scalingPolicy.paths}}
      ui:
        component: array
        input:
          inputType: text
        tooltip: Enter the path to the file(s) containing scaling policies definition
        placeholder: /path/to/file
    target_group_arn_key:
      type: string
      label: ECS target group ARN key (placeholder)
      default: <+targetGroupArn>
      ui:
        component: string
        tooltip: Specify the placeholder for target group ARN value
    remove_autoscaling_blue_svc:
      type: boolean
      label: Enable Auto Scaling In Swap Step
      default: false
      ui:
        component: boolean-card-select
        tooltip: Enable this option to remove autoscaling configuration from the blue service
        visible: ${{trafficShift == false}}
    update_green_svc:
      type: boolean
      label: Update green service
      default: false
      ui:
        component: boolean-card-select
        tooltip: Enable this option to update the green service instead of deleting it
    deploy_skip_steady_state:
      type: boolean
      label: Skip steady state check for deploy step
      default: false
      ui:
        component: boolean-card-select
        tooltip: Enable this option to skip steady state check for the deploy step
    deploy_steady_state_timeout:
      type: string
      label: Steady state check command timeout for deploy step
      default: 10m
      ui:
        tooltip: Specify the timeout to use during steady state check process for deploy step
        visible: ${deploySkipSteadyState == false}}
    load_balancer:
      type: string
      label: Elastic Load balancer
      required: true
      ui:
        tooltip: Enter the name of the Elastic Load Balancer
        placeholder: Please enter load balancer name
    traffic_shift:
      type: boolean
      label: Use Shift Traffic
      default: false
      ui:
        component: boolean-card-select
        tooltip: Enable this checkbox to activate traffic shifting for the ECS Blue Green deployment. When selected, traffic will be gradually shifted between target groups based on the weight percentages you define. If not selected, the deployment will follow the standard Blue Green process, swapping traffic 100% between the production and stage target groups.
    prod_listener_arn:
      type: string
      label: Prod listener
      required: true
      ui:
        tooltip: Select the ELB listener that you want to use as the Prod Listener.
        placeholder: Please enter ARN of Prod listener
    prod_listener_rule_arn:
      type: string
      label: Prod listener rule ARN
      ui:
        tooltip: If you do not enter a listener rule, Harness uses the Default rule.
        placeholder: Please enter ARN of Prod listener rule
    stage_listener_arn:
      type: string
      label: Stage listener
      required: true
      ui:
        tooltip: Select the ELB listener that you want to use as the Stage Listener.
        placeholder: Please enter ARN of Stage listener
        visible: ${{trafficShift == false}}
    stage_listener_rule_arn:
      type: string
      label: Stage listener rule ARN
      ui:
        tooltip: If you do not enter a listener rule, Harness uses the Default rule.
        placeholder: Please enter ARN of Stage listener rule
        visible: ${{trafficShift == false}}
    stage_target_group_arn:
      type: string
      label: Stage Target Group ARN
      ui:
        tooltip: Select the target group where the new service version will be deployed.
        placeholder: Please enter Stage Target Group ARN
        visible: ${{trafficShift == true}}
    trafficshift_config_type:
      type: string
      label: Traffic shift config type
      default: update
      required: true
      options:
        - new
        - update
    trafficshift_load_balancer:
      type: string
      label: Elastic Load balancer for traffic shift
      required: true
      default: ${{rollback.data.LOAD_BALANCER}}
      ui:
        tooltip: Enter the name of the Elastic Load Balancer for traffic shift
        placeholder: Please enter load balancer name
        warning: "${{values['trafficshift_config_type']=='update' && values['trafficshift_load_balancer']!='${{rollback.data.LOAD_BALANCER}}' ? 'Value for Traffic Shift Load balancer must be ${{rollback.data.LOAD_BALANCER}}' : null}}"
    trafficshift_listener_arn:
      type: string
      label: Listener ARN
      required: true
      ui:
        tooltip: Select the ELB listener that you want to use as the Prod Listener.
        placeholder: Please enter ARN of listener
        visible: ${{trafficshiftConfigType == 'new'}}
    trafficshift_listener_rule_arn:
      type: string
      label: Listener rule ARN
      ui:
        tooltip: If you do not enter a listener rule, Harness uses the Default rule.
        placeholder: Please enter ARN of listener rule
        visible: ${{trafficshiftConfigType == 'new'}}
    trafficshift_forward_config:
      type: array
      label: Forward configuration
      required: true
      ui:
        component: list
        layout: grid
        inputs:
          - inputType: textarea
            relativePath: TargetGroupArn
            label: Target Group Arn
            required: true
          - inputType: textarea
            relativePath: Weight
            label: Weight
            required: true
        tooltip: Enter the forward configuration details as a JSON string containing target group and weight pairs
        placeholder: Please enter forward configuration json
        visible: ${{trafficshiftConfigType == 'new'}}   
    trafficshift_weight:
      type: number
      label: New ECS Weight(%)
      required: true
      default: 0
      ui:
        tooltip: Specify the weight percentage for the new (stage) target group (service version)
        visible: ${{trafficshiftConfigType == 'update'}} 
    trafficshift_log_level:
      type: string
      label: Log level for traffic shift
      default: info
      options:
        - warn
        - error
        - info
        - debug
        - trace
      ui:
        component: select
        tooltip: Select the log level for the traffic shift step.
    trafficshift_steady_state_timeout:
      type: string
      label: Steady state check command timeout for traffic shift step
      default: 10m
      ui:
        tooltip: Specify the timeout to use during steady state check process for traffic shift step
    rollback_log_level:
      type: string
      label: Log level for rollback
      default: info
      options:
        - warn
        - error
        - info
        - debug
        - trace
      ui:
        component: select
        tooltip: Select the log level for the rollback step.
    rollback_skip_steady_state:
      type: boolean
      label: Skip steady state check for deploy rollback step
      default: false
      ui:
        component: boolean-card-select
        tooltip: Enable this option to skip steady state check for deploy rollback step
    rollback_steady_state_timeout:
      type: string
      label: Steady state check command timeout for rollback step
      default: 10m
      ui:
        tooltip: Specify the timeout to use during steady state check process for rollback step
        visible: ${{rollbackSkipSteadyState == false}}
    trafficshiftrollback_log_level:
      type: string
      label: Log level for traffic shift rollback
      default: info
      options:
        - warn
        - error
        - info
        - debug
        - trace
      ui:
        component: select
        tooltip: Select the log level for the traffic shift rollback step.
    trafficshiftrollback_steady_state_timeout:
      type: string
      label: Steady state check command timeout for traffic shift rollback step
      default: 10m
      ui:
        tooltip: Specify the timeout to use during steady state check process for traffic shift rollback step
  layout:
    - connector
    - region
    - cluster
    - task_def_mode
    - task_def
    - task_def_arn
    - service_def
    - load_balancer
    - prod_listener_arn
    - stage_listener_arn
    - trafficshift_config_type
    - trafficshift_load_balancer
    - trafficshift_listener_arn
    - trafficshift_forward_config
    - trafficshift_weight
    - title: Optional Configuration
      items:
        # Non-boolean fields first
        - scalable_targets
        - scaling_policies
        - prod_listener_rule_arn
        - stage_listener_rule_arn
        - stage_target_group_arn
        - target_group_arn_key
        - trafficshift_listener_rule_arn
        - deploy_steady_state_timeout
        - deploy_log_level
        - trafficshift_steady_state_timeout
        - trafficshift_log_level
        - rollback_steady_state_timeout
        - rollback_log_level
        - trafficshiftrollback_steady_state_timeout
        - trafficshiftrollback_log_level
        # Boolean fields grouped together
        - traffic_shift
        - remove_autoscaling_blue_svc
        - update_green_svc
        - deploy_skip_steady_state
        - rollback_skip_steady_state
  id: ecsBluegreenDeployWithTrafficShiftStrategy
  name: ECS BlueGreen Deploy With Traffic Shift Strategy
  description: Executes an ECS BlueGreen deployment with traffic shift
  version: 1
  author: harness
  module:
    - cd
  alias: bg-deploy-with-traffic-shift
  step:
    group:
      steps:
        - name: bluegreendeploy
          id: bluegreendeploystep
          template:
            uses: ecsBluegreenDeployStep@1.0.0
            with:
              connector: ${{inputs.connector}}
              log_level: ${{inputs.deploy_log_level}}
              cluster: ${{inputs.cluster}}
              region: ${{inputs.region}}
              task_def: ${{inputs.task_def}}
              service_def: ${{inputs.service_def}}
              scalable_targets: ${{inputs.scalable_targets}}
              scaling_policies: ${{inputs.scaling_policies}}
              task_def_arn: ${{inputs.task_def_arn}}
              target_group_arn_key: ${{inputs.target_group_arn_key}}
              remove_autoscaling_blue_svc: ${{inputs.remove_autoscaling_blue_svc}}
              update_green_svc:  ${{inputs.update_green_svc}}
              skip_steady_state: ${{inputs.deploy_skip_steady_state}}
              steady_state_timeout: ${{inputs.deploy_steady_state_timeout}}
              load_balancer: ${{inputs.load_balancer}}
              traffic_shift: ${{inputs.traffic_shift}}
              prod_listener_arn: ${{inputs.prod_listener_arn}}
              prod_listener_rule_arn: ${{inputs.prod_listener_rule_arn}}
              stage_listener_arn: ${{inputs.stage_listener_arn}}
              stage_listener_rule_arn: ${{inputs.stage_listener_rule_arn}}
              stage_target_group_arn: ${{inputs.stage_target_group_arn}}
        - name: bluegreentrafficshift
          id: bluegreentrafficshift
          template:
            uses: ecsBluegreenTrafficShiftStep@1.0.0
            with:
              connector: ${{inputs.connector}}
              log_level: ${{inputs.trafficshift_log_level}}
              cluster: ${{inputs.cluster}}
              region: ${{inputs.region}}
              config_type: ${{inputs.trafficshift_config_type}}
              load_balancer: ${{inputs.trafficshift_load_balancer}}
              listener_arn: ${{inputs.trafficshift_listener_arn}}
              listener_rule_arn: ${{inputs.trafficshift_listener_rule_arn}}
              forward_config: ${{json.format(${{inputs.trafficshift_forward_config}})}}
              stage_listener_arn: ${{rollback.data.STAGE_LISTENER_ARN}}
              stage_listener_rule_arn: ${{rollback.data.STAGE_LISTENER_RULE_ARN}}
              stage_target_group_arn: ${{rollback.data.STAGE_TARGET_GROUP_ARN}}
              prod_listener_arn: ${{rollback.data.PROD_LISTENER_ARN}}
              prod_listener_rule_arn: ${{rollback.data.PROD_LISTENER_RULE_ARN}}
              prod_target_group_arn: ${{rollback.data.PROD_TARGET_GROUP_ARN}}
              blue_service: ${{rollback.data.SERVICE_NAME}}
              green_service: ${{${{runtime.fqn}}.bluegreendeploystep.output.outputVariables.GREEN_SERVICE_NAME}}
              first_deployment: ${{rollback.data.FIRST_DEPLOYMENT}}
              weight: ${{inputs.trafficshift_weight}}
              steady_state_timeout: ${{inputs.trafficshift_steady_state_timeout}}
      rollback:
        - name: bluegreenrollback
          id: bluegreenrollbackstep
          template:
            uses: ecsBluegreenRollbackStep@1.0.0
            with:
              connector: ${{inputs.connector}}
              log_level: ${{inputs.rollback_log_level}}
              cluster: ${{inputs.cluster}}
              region: ${{inputs.region}}
              blue_service: ${{rollback.data.SERVICE_NAME}}
              green_service: ${{rollback.data.GREEN_SERVICE_NAME}}
              first_deployment: ${{rollback.data.FIRST_DEPLOYMENT}}
              new_service_created: ${{rollback.data.NEW_SERVICE_CREATED}}
              traffic_shift_started: ${{rollback.data.TRAFFIC_SHIFT_STARTED}}
              blue_service_json: ${{rollback.data.SERVICE_JSON}}
              blue_service_scalable_targets_json: ${{rollback.data.SCALABLE_TARGETS_JSON}}
              blue_service_scaling_policies_json: ${{rollback.data.SCALING_POLICIES_JSON}}
              green_service_json: ${{rollback.data.GREEN_SERVICE_JSON}}
              green_service_scalable_targets_json: ${{rollback.data.GREEN_SERVICE_SCALABLE_TARGETS_JSON}}
              green_service_scaling_policies_json: ${{rollback.data.GREEN_SERVICE_SCALING_POLICIES_JSON}}
              green_service_existed: ${{rollback.data.GREEN_SERVICE_EXIST}}
              rollback_green_service: ${{rollback.data.GREEN_SERVICE_ROLLBACK_DATA_EXIST}}
              skip_steady_state: ${{inputs.rollback_skip_steady_state}}
              steady_state_timeout: ${{inputs.rollback_steady_state_timeout}}
              load_balancer: ${{rollback.data.LOAD_BALANCER}}
              stage_listener_arn: ${{rollback.data.STAGE_LISTENER_ARN}}
              stage_listener_rule_arn: ${{rollback.data.STAGE_LISTENER_RULE_ARN}}
              stage_target_group_arn: ${{rollback.data.STAGE_TARGET_GROUP_ARN}}
              prod_listener_arn: ${{rollback.data.PROD_LISTENER_ARN}}
              prod_listener_rule_arn: ${{rollback.data.PROD_LISTENER_RULE_ARN}}
              prod_target_group_arn: ${{rollback.data.PROD_TARGET_GROUP_ARN}}
              traffic_shift: ${{rollback.data.IS_TRAFFIC_SHIFT}}
        - name: bluegreentrafficshiftrollback
          id: bluegreentrafficshiftrollback
          template:
            uses: ecsBluegreenTrafficShiftRollbackStep@1.0.0
            with:
              connector: ${{inputs.connector}}
              log_level: ${{inputs.trafficshiftrollback_log_level}}
              cluster: ${{inputs.cluster}}
              region: ${{inputs.region}}
              traffic_shift_data: ${{rollback.data.TRAFFIC_SHIFT_DATA}}
              steady_state_timeout: ${{inputs.trafficshiftrollback_steady_state_timeout}}
      on-failure:
        errors: all
        action: stage-rollback