template:
  inputs:
    connector:
      type: connector
      label: AWS Connector
      required: true
      oneof:
        - Aws
      ui:
        tooltip: Select the AWS connector to use for saving the cache to S3.
        allowedValueTypes:
          - fixed
          - runtime
          - expression
    cachekey:
      type: string
      label: Key
      required: true
      ui:
        component: string
        tooltip: Enter the key that the cache will be identified by. You can use the checksum macro to create a key that is based on a file's checksum. For example, myApp-{ { checksum filePath1 } }.
        allowedValueTypes:
          - fixed
          - runtime
          - expression
    source_path:
      type: array
      label: Source Paths
      required: true
      ui:
        component: array
        input:
          inputType: text
        tooltip: Specify a list of the files/folders to cache.
        allowedValueTypes:
          - fixed
          - expression
    endpoint:
      type: string
      label: Endpoint URL
      ui:
        component: string
        placeholder: http://minio.company.com
        tooltip: Enter the endpoint for S3-compatible providers. Not needed for AWS.
        allowedValueTypes:
          - fixed
          - runtime
          - expression
    bucket:
      type: string
      label: Bucket
      required: true
      ui:
        component: string
        tooltip: Enter the name of the S3 bucket where you want to upload the artifact.
        allowedValueTypes:
          - fixed
          - runtime
          - expression
    region:
      type: string
      label: Region
      required: true
      ui:
        component: string
        placeholder: us-east-1
        tooltip: Enter the relevant AWS region.
        allowedValueTypes:
          - fixed
          - runtime
          - expression
    archiveformat:
      type: string
      label: Archive Format
      default: tar
      items:
        - tar
        - gzip
        - zstd
      ui:
        tooltip: Select the archive format. The default format is tar.
        allowedValueTypes:
          - fixed
          - expression
    pathstyle:
      type: boolean
      label: Path Style
      default: false
      ui:
        component: boolean-card-switch
        tooltip: Select whether to use Virtual Hosted Style (http://bucket.host/key) or Path Style (http://host/bucket/key). For MinIO use Path Style (true). Default value is false.
        allowedValueTypes:
          - fixed
          - runtime
          - expression
    override:
      type: boolean
      label: Override Cache
      default: false
      ui:
        component: boolean-card-switch
        tooltip: Select this option to override the cache if the key already exists. By default, the Override Cache option is set to False.
        allowedValueTypes:
          - fixed
          - runtime
          - expression
    image:
      type: string
      label: Image
      default: plugins/cache
      ui:
        component: string
        tooltip: Specify the container image for the step.
        allowedValueTypes:
          - fixed
          - runtime
          - expression
  layout:
    - connector
    - region
    - bucket
    - cachekey
    - mount
    - title: Optional Configuration
      items:
        - endpoint
        - archiveformat
        - override
        - pathstyle
        - image
  id: saveCacheToS3
  name: Save Cache to S3
  description: Preserve files and directories between builds using AWS S3.
  version: 1
  author: harness
  module:
    - ci
  alias: build
  step:
    group:
      steps:
        - name: saveCacheS3
          id: saveCacheS3
          run:
            container:
              image: ${{inputs.image}}
            with:
              CACHE_KEY: ${{inputs.cachekey}}
              MOUNT: ${{inputs.source_path}}
              REBUILD: true
              ENDPOINT: ${{inputs.endpoint}}
              REGION: ${{inputs.region}}
              ARCHIVE_FORMAT: ${{inputs.archiveformat}}
              PATH_STYLE: ${{inputs.pathstyle}}
              OVERRIDE: ${{inputs.override}}
              EXIT_CODE: true
              BACKEND: s3
              BACKEND_OPERATION_TIMEOUT: 7200000s
              BUCKET: ${{inputs.bucket}}
              ACCESS_KEY: ${{${{inputs.connector}}.accessKey}}
              SECRET_KEY: ${{${{inputs.connector}}.secretKey}}
              ASSUME_ROLE: ${{${{inputs.connector}}.assumeRole}}
              OIDC_TOKEN_ID: ${{${{inputs.connector}}.oidcTokenId}}