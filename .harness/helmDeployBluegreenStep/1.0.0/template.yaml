template:
  inputs:
    kubeconfig:
      type: string
      label: Kubeconfig Path
      default: ${{infra.PLUGIN_HARNESS_KUBE_CONFIG_PATH}}
      required: true
      ui:
        tooltip: Enter the path to the 'kubeconfig' file.
        placeholder: path/kubeconfig
    namespace:
      type: string
      label: Namespace
      required: true
      default: default
      ui:
        tooltip: Enter the Kubernetes namespace for deployment.
        placeholder: namespace
    release:
      type: string
      label: Release
      required: true
      ui:
        tooltip: Enter the name for the current Helm release.
    ignore_failed_release:
      type: boolean
      label: Ignore Failed Release
      default: false
      ui:
        component: boolean-card-select
        tooltip: Enable this option to ignore failed releases and proceed with deployment.
    skip_deploy_steady_check:
      type: boolean
      label: Skip Deploy Steady Check
      default: false
      ui:
        tooltip: Enable this option to skip the steady state check after deployment.
        component: boolean-card-select
    upgrade_with_install:
      type: boolean
      label: Upgrade with Install
      default: false
      ui:
        component: boolean-card-select
        tooltip: Select this option to use "helm upgrade --install" instead of "helm install", allowing upgrades if the release already exists (only applicable when CLI is used).
    deploy_test:
      type: boolean
      label: Run Tests
      default: false
      ui:
        component: boolean-card-select
        tooltip: Run Helm chart tests after rollback command.
    deploy_test_logs:
      type: boolean
      label: Test Logs
      default: false
      ui:
        component: boolean-card-select
        tooltip: Enable this option to print out logs from test pods.
        visible: ${{runtests == true}}
    deploy_flags:
      type: array
      label: Command Flags
      ui:
        component: list
        layout: grid
        inputs:
          - inputType: select
            relativePath: commandType
            label: Command Type
            inputConfig:
              options:
                - label: get manifest
                  value: get_manifest
                - label: list
                  value: list
                - label: history
                  value: history
                - label: install
                  value: install
                - label: upgrade
                  value: upgrade
                - label: rollback
                  value: rollback
                - label: uninstall
                  value: uninstall
                - label: test
                  value: test
                - label: template
                  value: template
          - inputType: textarea
            relativePath: flag
            label: Flag
    deploy_env_vars:
      type: list
      label: Environment Variables
      ui:
        layout: grid
        inputs:
          - inputType: text
            label: Key
            relativePath: key
          - inputType: text
            label: Value
            relativePath: value
    instanceunittype:
      type: string
      label: Instance count
      required: true
      default: count
      options:
        - count
        - percentage
      ui:
        visible: false
        component: select
        tooltip: Select the instance unit type.
    instances:
      type: number
      label: Instances
      required: true
      default: 1
      ui:
        visible: false
        tooltip: Enter the volume of instances to create canary with.
    chart:
      type: string
      label: Chart Path
      required: true
      ui:
        tooltip: Directory path or .tgz file path.
        placeholder: path/helm/chart/dir
    subchart:
      type: string
      label: Subchart Path
      ui:
        visible: ${{manifests != null}}
        tooltip: Enter the path within Helm Chart to the subchart.
    values:
      type: array
      label: Values File Paths
      ui:
        visible: ${{manifests != null}}
        component: array
        input: 
          inputType: text
        tooltip: List of values file paths.
        placeholder: path/values.yaml,path2/value.yaml,path3/vals.yaml
    skip_deploy_steady_check_for_jobs:
      type: boolean
      label: Skip Deploy Steady Check for Jobs
      default: false
      ui:
        component: boolean-card-select
        tooltip: Skip the steady state check for jobs after rollback command.
    deploy_log_level:
      type: string
      label: Log Level
      default: error
      options:
        - info
        - warn
        - error
        - debug
        - trace
      ui:
        component: select
        tooltip: Select the log level for this step.
    skip_default_values_yaml:
      type: boolean
      label: Skip Default Values YAML
      default: false
      ui:
        component: boolean-card-select
    enforce_infra_namespace:
      type: boolean
      label: Enforce Namespace
      default: false
      ui:
        component: boolean-card-select
    server_render:
      type: boolean
      label: Server Rendering
      default: false
      ui:
        tooltip: Enable this option to use Kubernetes cluster server to render manifests instead of locally.
  layout:
    - title: Optional Configuration
      items:
        - kubeconfig
        - namespace
        - release
        - chart
        - subchart
        - values
        - instanceunittype
        - instances
        - deploy_log_level
        - deploy_flags
        - deploy_env_vars
        - ignore_failed_release
        - skip_deploy_steady_check
        - upgrade_with_install
        - deploy_test
        - deploy_test_logs
        - skip_deploy_steady_check_for_jobs
        - skip_default_values_yaml
        - enforce_infra_namespace
        - server_render
  id: HelmDeployBlueGreenStep
  name: Helm Deploy Blue Green
  description: Deploys Helm chart using blue-green strategy.
  version: 1
  author: harness
  module:
    - cd
  alias: deploy
  step:
    group:
      steps:
        - name: Helm Deploy Blue Green
          id: HelmDeployBlueGreenStep
          run:
            container:
              image: harnessdev/helm-deploy:linux-arm64-0.0.5
              connector: account.harnessImage
            env:
              PLUGIN_STRATEGY: blue-green
              PLUGIN_RELEASE_NAME: ${{inputs.release}} 
              PLUGIN_KUBECONFIG_PATH: ${{inputs.kubeconfig}}
              PLUGIN_MANIFEST_PATH: ${{inputs.chart}}
              PLUGIN_SUBCHART_PATH: ${{inputs.subchart}}
              PLUGIN_VALUES_PATH: ${{inputs.values}}
              PLUGIN_NAMESPACE: ${{inputs.namespace}}
              PLUGIN_IGNORE_HISTORY_FAILURE: ${{inputs.ignore_failed_release}}
              PLUGIN_SKIP_STEADY_STATE_CHECK: ${{inputs.skip_deploy_steady_check}}
              PLUGIN_STEADY_STATE_CHECK_FOR_JOBS: ${{inputs.skip_deploy_steady_check_for_jobs}}
              PLUGIN_FF_CDP_SKIP_DEFAULT_VALUES_YAML_NG: ${{inputs.skip_default_values_yaml}}
              PLUGIN_COMMAND_FLAGS: ${{json.format(${{inputs.deploy_flags}})}}
              PLUGIN_ENFORCE_INFRA_NAMESPACE: ${{inputs.enforce_infra_namespace}}
              PLUGIN_INSTANCES: ${{inputs.instances}}
              PLUGIN_INSTANCES_UNIT_TYPE: ${{inputs.instanceunittype}}
              PLUGIN_SERVER_RENDERING: ${{inputs.server_render}}
              PLUGIN_LOG_LEVEL: ${{inputs.deploy_log_level}}
        - if: ${{inputs.deploy_test == true}}
          name: Helm Test Step
          id: HelmTestStep
          run:
            container:
              image: harnessdev/helm-test:linux-amd64-0.0.5
              connector: account.harnessImage
            env:
              PLUGIN_KUBECONFIG_PATH: ${{inputs.kubeconfig}}
              PLUGIN_NAMESPACE: ${{inputs.namespace}}
              PLUGIN_RELEASE_NAME: ${{inputs.release}} 
              PLUGIN_COMMAND_FLAGS: ${{json.format(${{inputs.deploy_flags}})}}
              PLUGIN_PRINT_LOGS: ${{inputs.deploy_test_logs}}
              PLUGIN_ENFORCE_INFRA_NAMESPACE: ${{inputs.enforce_infra_namespace}}
              PLUGIN_LOG_LEVEL: ${{inputs.deploy_log_level}}