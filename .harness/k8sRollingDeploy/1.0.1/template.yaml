template:
  inputs:
    kubeconfig:
      type: string
      label: Kubeconfig Path
      default: ${{unified.workspace}}/kubeconfig
      required: true
      ui:
        tooltip: The path to the 'kubeconfig' file.
        placeholder: path/kubeconfig
    namespace:
      type: string
      label: Namespace
      required: true
      default: ${{infra.namespace}}
      ui:
        tooltip: Kubernetes namespace for deployment.
        placeholder: namespace
    manifests:
      type: array
      label: Manifest Path
      default:  something random
      required: true
      ui:
        component: array
        input: 
          inputType: text
        tooltip: List of manifest file paths.
        placeholder: path/manifest
    releasename:
      type: string
      label: Release Name
      default: ${{infra.release}}
      required: true
      ui:
        tooltip: Name for the current Harness release.
        placeholder: release
    skipdryrun:
      type: boolean
      label: Skip Dry Run
      ui:
        component: boolean-card-switch
        tooltip: By default, Harness uses the --dry-run flag on the kubectl apply command, which prints the object that would be sent to the cluster without really sending it. If the Skip Dry Run option is selected, Harness will not use the --dry-run flag.
    pruning:
      type: boolean
      label: Enable Kubernetes Pruning
      ui:
        component: boolean-card-switch
        tooltip: Remove any resources that were present in an old manifest, but no longer present in the manifest used for the current deployment.
    skipsteadystatecheck:
      type: boolean
      label: Skip Steady State Check
      ui:
        component: boolean-card-switch
        tooltip: Skip the steady state check.
    describeresources:
      type: boolean
      label: Describe Resources
      ui:
        component: boolean-card-switch
        tooltip: Describe resources (Wrap-Up).
    serviceid:
      type: string
      label: Service ID
      default: ${{service.identifier}}
      ui:
        tooltip: Service ID for release.
        placeholder: service id
    environmentid:
      type: string
      label: Environment ID
      default: ${{env.identifier}}
      ui:
        tooltip: Environment ID for release.
        placeholder: environment id
    infraid:
      type: string
      label: Infrastructure ID
      default: ${{infra.identifier}}
      ui:
        tooltip: Infrastructure ID for release.
        placeholder: infra id
    infrakey:
      type: string
      label: Infrastructure Key
      default: ${{infra.infrastructureKey}}
      ui:
        tooltip: Infrastructure key for release.
        placeholder: infra key
    manifestoutputpath:
      type: string
      label: Manifest Output Path
      ui:
        tooltip: Directory path for output of consolidated manifest.
        placeholder: path/manifest/output
    skipresourceversioning:
      type: boolean
      label: Skip Resource Versioning
      default: false
      ui:
        component: boolean-card-switch
        tooltip: Skip resource versioning.
    supporthpaandpdb:
      type: boolean
      label: Support HPA and PDB
      default: false
      ui:
        component: boolean-card-switch
        tooltip: Support HPA and PDB.
    skipaddingtrackselector:
      type: boolean
      label: Skip Adding Track Selector
      default: false
      ui:
        component: boolean-card-switch
        tooltip: Skip adding track selector to deployments.
    flags:
      type: array
      label: Command Flags
      ui:
        component: list
        layout: grid
        inputs:
          - inputType: select
            relativePath: commandType
            label: Command Type
            inputConfig:
              options:
                - label: Apply
                  value: Apply
          - inputType: textarea
            relativePath: flag
            label: Flag
    loglevel:
      type: string
      label: Log Level
      default: error
      options:
        - info
        - warn
        - error
        - debug
        - trace
      ui:
        component: select
        tooltip: Set the log level for the plugin.
    image:
      type: string
      label: Plugin Image
      default: harnessdev/k8s-deploy:linux-amd64-latest
      required: true
      ui:
        tooltip: Enter the Kubernetes rolling plugin image.
  
  layout:
    - kubeconfig
    - namespace
    - manifests
    - releasename
    - title: Optional Configuration
      items:
        - title: Command Options
          items:  
            - skipdryrun
        - title: Resources Options
          items:
            - describeresources
            - pruning
            - skipresourceversioning
            - skipaddingtrackselector
            - supporthpaandpdb
        - title: Release Configuration
          items:
            - serviceid
            - environmentid
            - infraid
            - infrakey
        - skipsteadystatecheck
        - manifestoutputpath
        - loglevel
        - image
  id: k8sRollingDeploy
  name: K8s Rolling Deploy
  description: Use a rolling update to schedule new pods on nodes with available resources. This step uses the number of replicas specified in the manifest.
  version: 1
  author: harness
  module:
    - cd
  alias: deploy
  step:
    group:
      steps:
        - name: K8s Rolling Deploy
          id: k8sRollingDeploy
          run:
            container:
              image: ${{inputs.image}}
              connector: account.harnessImage
            env:
              PLUGIN_KUBECONFIG_PATH: ${{inputs.kubeconfig}}
              PLUGIN_STRATEGY: rolling
              PLUGIN_RELEASE_NAME: ${{inputs.releasename}}
              PLUGIN_SKIP_DRY_RUN: ${{inputs.skipdryrun}}
              PLUGIN_MANIFEST_PATH: ${{inputs.manifests}}
              PLUGIN_NAMESPACE: ${{inputs.namespace}}
              PLUGIN_SERVICE_ID: ${{inputs.serviceid}}
              PLUGIN_ENVIRONMENT_ID: ${{inputs.environmentid}}
              PLUGIN_INFRA_ID: ${{inputs.infraid}}
              PLUGIN_INFRA_KEY: ${{inputs.infrakey}}
              PLUGIN_MANIFEST_OUTPUT_PATH: ${{inputs.manifestoutputpath}}
              PLUGIN_PRUNING: ${{inputs.pruning}}
              PLUGIN_SKIP_RESOURCE_VERSIONING: ${{inputs.skipresourceversioning}}
              PLUGIN_FF_CDS_SUPPORT_HPA_AND_PDB_NG: ${{inputs.supphpaandpdb}}
              PLUGIN_SKIP_ADDING_TRACK_SELECTOR: ${{inputs.skipaddingtrackselector}}
              PLUGIN_COMMAND_FLAGS_JSON: ${{json.format(${{inputs.flags}})}}
              PLUGIN_LOG_LEVEL: ${{inputs.loglevel}}
