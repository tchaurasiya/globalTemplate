template:
  inputs:
    infra:
      type: connector
      label: Azure connector
      required: true
      default: ${{infra.connector}} 
      oneof:
        - Azure
      ui:
        tooltip: Select the Azure connector for authentication
        allowedValueTypes:
          - fixed
          - runtime
          - expression 
    artifact:
      type: connector
      label: Artifact connector
      required: true
      default: ${{service.artifacts.primary.connector}} 
      oneof:
        - Azure
        - Docker
        - Nexus
        - Artifactory
      ui:
        tooltip: Select the artifact connector for accessing deployment artifacts
        allowedValueTypes:
          - fixed
          - runtime
          - expression       
    app:
      type: string
      label: Function app name
      required: true
      ui:
        tooltip: Enter the name of the Azure Function App to deploy to
        placeholder: enter function app 
    slot:
      type: string
      label: Deployment slot
      required: true
      ui:
        tooltip: Enter the deployment slot to deploy to
        placeholder: enter slot
    
    deploy_type:
      type: string
      label: Deployment type
      required: true
      default: ${{(artifact.repositoryFormat == "" || artifact.repositoryFormat == "docker")? "CONTAINER":"ZIP"}}
      options:
        - ZIP
        - CONTAINER
      ui:
        component: select
        tooltip: Select the type of deployment (ZIP package or CONTAINER image)    
    source:
      type: string
      label: Container source
      required: false
      default: ${{service.artifacts.primary.uses}}
      options:
        - docker-registry
        - acr
        - nexus3
        - artifactory
      ui:
        component: select
        tooltip: Select the source repository type for container image
    
    subscription_id:
      type: string
      label: Subscription ID
      default: ${{infra.subscription}}
      required: true
      ui:
        tooltip: Enter the Azure subscription ID where the function app is deployed
    
    resource_group:
      type: string
      label: Resource group
      required: true
      default: ${{infra.resourceGroup}}
      ui:
        tooltip: Enter the Azure resource group containing the function app

    image:
      type: string
      label: Container image
      required: false
      default: ${{artifact.metadata.image}}
      ui:
        tooltip: Enter the name of the container image
    
    acr_name:
      type: string
      label: ACR registry name
      required: false
      default: ${{service.artifacts.primary.registry}}
      ui:
        tooltip: Enter the name of the Azure Container Registry

    log_level:
      type: string
      label: Log Level
      default: "info"
      options:
        - info
        - debug
        - warning
        - error
      ui:
        component: select
        tooltip: Select the log level for the plugin execution
    pre_cmd:
      type: string
      label: Pre execute command
      required: false
      ui:
        tooltip: Enter the command to execute before plugin execution
        placeholder: echo "Pre Execute Command"
    env_vars:
      type: list
      label: Environment variables
      ui:
        component: key-value-pairs
        tooltip: Specify the environment variables to pass to the plugin
    deploy_cmd:
      type: string
      label: Deploy command option
      required: false
      ui:
        component: text
        tooltip: Enter the deploy command option
    
     
    rollback_log_level:
      type: string
      label: Rollback command log level
      default: error
      options:
        - info
        - warn
        - error
        - debug
        - trace
      ui:
        component: select
        tooltip: Set the log level for the rollback step.
  layout:
    - title: Artifact Configuration
      items:
        - artifact
        - deploy_type
        - source

    - title: Azure Infra
      items:
        - infra
        - subscription_id
        - resource_group
    - title: Container Configuration
      items:
        - image
        - acr_name

    - title: Optional Configuration
      items:
          - title: Execution
            items:
              - title: Deploy Command
                items:
                  - azure_function_step
                  - app
                  - slot
                  - deploy_cmd
                  - pre_cmd
                  - env_vars
                  - log_level
          - title: Rollback
            items:
              - rollback_log_level
              - rollback_step

  id: azureFunctionDeployStrategy
  name: Azure Function Deploy Strategy
  description: Harness managed Azure Function deployment strategy with support for ZIP and container deployments.
  version: 1
  author: harness
  module:
    - cd
  alias: deploy
  step:
    group:
      steps:
        - name: Deploy Azure Function
          id: deploystep
          template:
            uses: azureFunctionDeployStep@1.0.0
            with:
              infra: ${{inputs.infra}}
              artifact: ${{inputs.artifact}}
              app: ${{inputs.app}}
              slot: ${{inputs.slot}}
              cmd: deploy
              deploy_type: ${{inputs.deploy_type}}
              source: ${{inputs.source}}
              subscription_id: ${{inputs.subscription_id}}
              resource_group: ${{inputs.resource_group}}
              image: ${{inputs.image}}
              acr_name: ${{inputs.acr_name}}
              log_level: ${{inputs.log_level}}
              pre_cmd: ${{inputs.pre_cmd}}
              env_vars: ${{inputs.env_vars}}
              deploy_cmd: ${{inputs.deploy_cmd}}
      rollback:
        - name: Rollback Azure Function
          id: rollbackstep
          template:
            uses: azureFunctionRollbackStep@1.0.0
            with:
              infra: ${{inputs.infra}}
              artifact: ${{inputs.artifact}}
              app: ${{rollback.PLUGIN_FUNCTION_NAME}}
              slot: ${{rollback.PLUGIN_DEPLOYMENT_SLOT}}
              cmd: rollback
              deploy_type: ${{inputs.deploy_type}}
              source: ${{inputs.source}}
              subscription_id: ${{inputs.subscription_id}}
              resource_group: ${{inputs.resource_group}}
              image: ${{inputs.image}}
              acr_name: ${{inputs.acr_name}}
              log_level: ${{inputs.rollback_log_level}}
              pre_cmd: ${{inputs.pre_cmd}}
              env_vars: ${{inputs.env_vars}}
              deploy_cmd: ${{inputs.deploy_cmd}}
      on-failure:
        errors: all
        action: stage-rollback