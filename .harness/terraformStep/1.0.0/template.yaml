template:
  inputs:
    command:
      type: string
      label: Command
      required: true
      options:
        - init
        - plan
        - apply
        - destroy
        - plan-destroy
        - plan-refresh-only
        - apply-refresh-only
        - detect-drft
        - validate
        - migrate-state
        - import
      ui:
        component: select
    target:
      type: array
      label: Add Target
      ui: 
        visible: ${{command == "plan"}}
        component: array
        input:
          inputType: text
    replace:
      type: array
      label: Add Replace
      ui: 
        visible: ${{command == "plan"}}
        component: array
        input:
          inputType: text
    import:
      type: list
      label: Add Import
      ui:
        visible: ${{command == "import"}}
        component: list
        layout: grid
        inputs:
          - inputType: text
            relativePath: id
            label: ID
            required: true
          - inputType: text
            relativePath: address
            label: Address
    image:
      type: string
      label: Plugin Image
      default: plugins/harness_terraform_vm
      ui:
        tooltip: Enter the plugin image to use for this step.
  layout:
    - command
    - import
    - title: Optional Configuration
      items:
        - target
        - replace
        - image
  id: terraformStep
  name: Terraform Step
  description: IACM Terraform Step
  version: 1
  author: harness
  module:
    - iacm
  alias: iacm
  step:
    run:
      container:
        image: <+inputs.image>
      with:
        PROVISIONER: terraform
        # Step Inputs
        COMMAND: <+inputs.command>
        PLAN_TARGET: <+inputs.target>
        PLAN_REPLACE: <+inputs.replace>
        IMPORT: ${{json.format(${{inputs.import}})}}
        # Root Dir
        ROOT_DIR: <+iacmOutput.rootDir>
      env:
        # AWS Provider connector details
        PLUGIN_ACCESS_KEY: ${{connectorInputs.get(${{iacmOutput.awsConnector}}).accessKey}}
        PLUGIN_SECRET_KEY: ${{connectorInputs.get(${{iacmOutput.awsConnector}}).secretKey}}
        PLUGIN_SESSION_TOKEN: ${{connectorInputs.get(${{iacmOutput.awsConnector}}).sessionToken}}
        PLUGIN_ASSUME_ROLE: ${{connectorInputs.get(${{iacmOutput.awsConnector}}).crossAccountRoleArn}}
        PLUGIN_EXTERNAL_ID: ${{connectorInputs.get(${{iacmOutput.awsConnector}}).externalId}}
        PLUGIN_AWS_OIDC_TOKEN: ${{connectorInputs.get(${{iacmOutput.awsConnector}}).oidcToken}}
        PLUGIN_AWS_OIDC_ROLE_ARN: ${{connectorInputs.get(${{iacmOutput.awsConnector}}).iamRoleArn}}
        PLUGIN_AWS_BACK_OFF_MAX_ATTEMPTS: ${{connectorInputs.get(${{iacmOutput.awsConnector}}).retryCount}}
        PLUGIN_JSON_KEY: ${{connectorInputs.get(${{iacmOutput.awsConnector}}).jsonKey}}
        # GCP Provider connector details
        PLUGIN_GCP_OIDC_TOKEN: ${{connectorInputs.get(${{iacmOutput.gcpConnector}}).oidcToken}}
        PLUGIN_GCP_PROJECT_ID: ${{connectorInputs.get(${{iacmOutput.gcpConnector}}).gcpProjectId}}
        PLUGIN_GCP_POOL_ID: ${{connectorInputs.get(${{iacmOutput.gcpConnector}}).workloadPoolId}}
        PLUGIN_GCP_PROVIDER_ID: ${{connectorInputs.get(${{iacmOutput.gcpConnector}}).providerId}}
        PLUGIN_GCP_SERVICE_ACCOUNT_EMAIL_ID: ${{connectorInputs.get(${{iacmOutput.gcpConnector}}).serviceAccountEmail}}
        # Azure Provider connector details
        CLIENT_ID: ${{connectorInputs.get(${{iacmOutput.azureConnector}}).clientId}}
        TENANT_ID: ${{connectorInputs.get(${{iacmOutput.azureConnector}}).tenantId}}
        CLIENT_SECRET: ${{connectorInputs.get(${{iacmOutput.azureConnector}}).clientSecret}}
        CLIENT_CERTIFICATE: ${{connectorInputs.get(${{iacmOutput.azureConnector}}).clientCertificate}}
        # Repository Connector details
        DRONE_REPO_SCM: ${{iacmOutput.repoType}}
        DRONE_GIT_HTTP_URL: ${{iacmOutput.repoUrl}}
        DRONE_NETRC_MACHINE: ${{iacmOutput.repoMachine}}
        DRONE_NETRC_USERNAME: ${{iacmOutput.repoUsername}}
        DRONE_NETRC_PASSWORD: ${{iacmOutput.repoToken}}
        DRONE_SSH_KEY: ${{iacmOutput.repoSshKey}}
