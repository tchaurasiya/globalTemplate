template:
  inputs:
    connector:
      type: connector
      label: AWS connector
      required: true
      default: ${{infra.connector}}
      oneof:
        - Aws
      ui:
        tooltip: Select the Harness AWS Connector for the AWS account where you want to perform ECS Bluegreen swap target groups
        placeholder: Select AWS Connector
    cluster:
      type: string
      label: Cluster
      required: true
      default: ${{infra.cluster}}
      ui:
        component: string
        tooltip: Enter the AWS cluster name where the ECS service is deployed
    region:
      type: string
      label: Region
      required: true
      default: ${{infra.region}}
      ui:
        component: string
        placeholder: us-east-1
        tooltip: Enter the AWS region where the ECS cluster is located
    log_level:
      type: string
      label: Log level
      default: info
      options:
        - warn
        - error
        - info
        - debug
        - trace
      ui:
        component: select
        tooltip: Set the log level for the step
    blue_service:
      type: string
      label: Blue (old) service name
      ui:
        component: string
        tooltip: Enter the name of the blue (old) service
        placeholder: Please enter blue (old) service name
    green_service:
      type: string
      label: Green (new) service name
      required: true
      ui:
        component: string
        tooltip: Enter the name of the green (new) service
        placeholder: Please enter green (new) service name
    first_deployment:
      type: boolean
      label: Is first deployment
      default: false
      ui:
        component: boolean-card-select
        tooltip: Is this currently a first deployment?
    not_downsize_old:
      type: boolean
      label: Do not downsize old service
      default: false
      ui:
        component: boolean-card-select
        tooltip: Use this setting to choose whether to downsize the older, previous version of the service. By default, the previous service is downsized to 0. The service is downsized, but not deleted. If the older service needs to be brought back up again, it is still available.
    downsize_delay:
      type: string
      label: Downsize Old Service Delay
      default: 10s
      ui:
        tooltip: Specify the delay before downsizing the old service
        visible: ${{doNotDownsizeOld == false}}
    scalable_targets:
      type: array
      label: ECS scalable targets
      default: ${{service.manifests.scalableTarget.paths}}
      ui:
        component: array
        input:
          inputType: text
        tooltip: Enter the path to the file(s) containing scalable target definition
        placeholder: /path/to/file
    scaling_policies:
      type: array
      label: ECS scaling policies
      default: ${{service.manifests.scalingPolicy.paths}}
      ui:
        component: array
        input:
          inputType: text
        tooltip: Enter the path to the file(s) containing scaling policies definition
        placeholder: /path/to/file
    skip_steady_state:
      type: boolean
      label: Skip steady state check
      default: false
      ui:
        component: boolean-card-select
        tooltip: Turn on to skip steady state check 
    steady_state_timeout:
      type: string
      label: Steady state check command timeout
      default: 10m
      ui:
        tooltip: Specify the timeout to use during steady state check process
        visible: ${{skipSteadyState == false}}
    load_balancer:
      type: string
      label: Elastic Load balancer
      required: true
      ui:
        tooltip: Enter the name of the Elastic Load Balancer
        placeholder: Please enter load balancer name
    prod_listener_arn:
      type: string
      label: Prod listener
      required: true
      ui:
        tooltip: Select the ELB listener that you want to use as the Prod Listener.
        placeholder: Please enter ARN of Prod listener
    prod_listener_rule_arn:
      type: string
      label: Prod listener rule ARN
      ui:
        tooltip: If you do not enter a listener rule, Harness uses the Default rule.
        placeholder: Please enter ARN of Prod listener rule
    prod_target_group_arn:
      type: string
      label: Prod listener target group
      required: true
      ui:
        tooltip: Enter the target group for prod deployment
        placeholder: Please enter ARN of Prod listener target group
    stage_listener_arn:
      type: string
      label: Stage listener
      required: true
      ui:
        tooltip: Select the ELB listener that you want to use as the Stage Listener.
        placeholder: Please enter ARN of Stage listener
    stage_listener_rule_arn:
      type: string
      label: Stage listener rule ARN
      ui:
        tooltip: If you do not enter a listener rule, Harness uses the Default rule.
        placeholder: Please enter ARN of Stage listener rule
    stage_target_group_arn:
      type: string
      label: Stage listener target group
      required: true
      ui:
        tooltip: Enter the target group for stage deployment
        placeholder: Please enter ARN of Stage listener target group
  layout:
    - connector
    - region
    - cluster
    - green_service
    - load_balancer
    - prod_listener_arn
    - prod_target_group_arn
    - stage_listener_arn
    - stage_target_group_arn
    - title: Optional Configuration
      items:
        - scalable_targets
        - scaling_policies
        - prod_listener_rule_arn
        - stage_listener_rule_arn
        - blue_service
        - first_deployment
        - not_downsize_old
        - downsize_delay
        - skip_steady_state
        - steady_state_timeout
        - log_level
  id: ecsBluegreenSwapTargetGroupsStep
  name: ECS BlueGreen Swap Target Groups Step
  description: Executes a swap of ECS BlueGreen Target Groups
  version: 1
  author: harness
  module:
    - cd
  alias: bg-swap-target-groups
  step:
    group:
      steps:
        - name: bluegreenswap
          id: bluegreenswap
          run:
            container:
              image: harnessdev/ecs-bluegreen-swap-target-groups:0.0.1
              connector: account.harnessImage
            env:
              PLUGIN_HARNESS_CONNECTOR: ${{inputs.connector.id}}
              PLUGIN_LOG_LEVEL: ${{inputs.log_level}}
              PLUGIN_CLUSTER: ${{inputs.cluster}}
              PLUGIN_REGION: ${{inputs.region}}
              PLUGIN_BLUE_SERVICE: ${{inputs.blue_service}}
              PLUGIN_GREEN_SERVICE: ${{inputs.green_service}}
              PLUGIN_FIRST_DEPLOYMENT: ${{inputs.first_deployment}}
              PLUGIN_DO_NOT_DOWNSIZE_OLD_SERVICE: ${{inputs.not_downsize_old}}
              PLUGIN_DOWNSIZE_OLD_SERVICE_DELAY: ${{inputs.downsize_delay}}
              PLUGIN_SCALABLE_TARGETS: ${{inputs.scalable_targets}}
              PLUGIN_SCALING_POLICIES: ${{inputs.scaling_policies}}
              PLUGIN_STEADY_STATE_CHECK: ${{inputs.skip_steady_state}}
              PLUGIN_STEADY_STATE_CHECK_TIMEOUT: ${{inputs.steady_state_timeout}}
              PLUGIN_LOAD_BALANCER: ${{inputs.load_balancer}}
              PLUGIN_STAGE_LISTENER_ARN: ${{inputs.stage_listener_arn}}
              PLUGIN_STAGE_LISTENER_RULE_ARN: ${{inputs.stage_listener_rule_arn}}
              PLUGIN_STAGE_TARGET_GROUP_ARN: ${{inputs.stage_target_group_arn}}
              PLUGIN_PROD_LISTENER_ARN: ${{inputs.prod_listener_arn}}
              PLUGIN_PROD_LISTENER_RULE_ARN: ${{inputs.prod_listener_rule_arn}}
              PLUGIN_PROD_TARGET_GROUP_ARN: ${{inputs.prod_target_group_arn}}
              PLUGIN_TRAFFIC_SHIFT: false
              PLUGIN_ROLLBACK_DATA: ${{rollback.data}}