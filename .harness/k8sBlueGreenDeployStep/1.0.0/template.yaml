template:
  inputs:
    kubeconfig:
      type: string
      label: Kubeconfig Path
      default: ${{infra.PLUGIN_HARNESS_KUBE_CONFIG_PATH}}
      ui:
        tooltip: Enter the path to the 'kubeconfig' file
    namespace:
      type: string
      label: Namespace
      default: ${{infra.namespace}}
      ui:
        tooltip: Enter the Kubernetes namespace for deployment
    manifests:
      type: array
      label: Manifest Path
      default: ${{runtime.manifestPath}}
      ui:
        component: array
        input:
          inputType: text
        tooltip: Enter a list of manifest file paths
    manifest_output_path:
      type: string
      label: Manifest Output Path
      ui:
        tooltip: Enter the directory path for consolidated manifest output
        placeholder: path/manifest/output
    release:
      type: string
      label: Release Name
      default: ${{infra.release}}
      ui:
        tooltip: Enter the name for the current Harness release
    service_id:
      type: string
      label: Service ID
      default: ${{service.identifier}}
      ui:
        tooltip: Enter the service ID for release
    environment_id:
      type: string
      label: Environment ID
      default: ${{env.identifier}}
      ui:
        tooltip: Enter the environment ID for release
    infra_id:
      type: string
      label: Infrastructure ID
      default: ${{infra.identifier}}
      ui:
        tooltip: Enter the infrastructure ID for release
    infra_key:
      type: string
      label: Infrastructure Key
      default: ${{infra.infrastructureKey}}
      ui:
        tooltip: Enter the infrastructure key for release
    skip_resource_versioning:
      type: boolean
      label: Skip Resource Versioning
      default: false
      ui:
        component: boolean-card-select
        tooltip: Skip resource versioning

    skip_unchanged_manifest:
      type: boolean
      label: Skip Unchanged Manifest
      default: false
      ui:
        component: boolean-card-select
        tooltip: Skip unchanged manifest
    skip_dry_run:
      type: boolean
      label: Skip Dry Run
      default: false
      ui:
        component: boolean-card-select
        tooltip: By default, Harness uses the --dry-run flag on the kubectl apply command, which prints the object that would be sent to the cluster without really sending it. If the Skip Dry Run option is selected, Harness will not use the --dry-run flag
    pruning:
      type: boolean
      label: Kubernetes Pruning
      default: false
      ui:
        component: boolean-card-select
        tooltip: Remove any resources that were present in an old manifest, but no longer present in the manifest used for the current deployment.

    print_manifests:
      type: boolean
      label: Print Manifests
      default: false
      ui:
        component: boolean-card-select
        tooltip: Print the manifests that will be applied
    server_side_apply:
      type: boolean
      label: Server Side Apply
      default: false
      ui:
        component: boolean-card-select
        tooltip: Use server-side apply instead of client-side apply
    encrypt_yaml_output:
      type: boolean
      label: Encrypt YAML Output
      default: false
      ui:
        component: boolean-card-select
        tooltip: Encrypt the output YAML file
    flags:
      type: array
      label: Command Flags
      ui:
        component: list
        layout: grid
        inputs:
          - inputType: select
            relativePath: commandType
            label: Command Type
            inputConfig:
              options:
                - label: Apply
                  value: Apply
                - label: Describe
                  value: Describe
          - inputType: textarea
            relativePath: flag
            label: Flag
            ui:
              placeholder: --warnings-as-errors
    apply_timeout:
      type: string
      label: Apply command timeout
      default: 5m
      ui:
        tooltip: Enter the timeout to use during apply command execution
    log_level:
      type: string
      label: Log Level
      default: info
      options:
        - warn
        - error
        - info
        - debug
        - trace
      ui:
        component: select
        tooltip: Select the log level for this step

    skip_steady_state_check:
      type: boolean
      label: Skip Steady State Check
      default: false
      ui:
        component: boolean-card-select
        tooltip: Skip the steady state check
    describe_resources:
      type: boolean
      label: Describe Resources
      default: false
      ui:
        component: boolean-card-select
        tooltip: Flag to describe resources in the steady state check
        visible: ${{skipSteadyStateCheck == false}}
    steady_state_timeout:
      type: string
      label: Steady state command timeout
      default: 5m
      ui:
        tooltip: Enter the timeout to use during steady state command execution
        visible: ${{skipSteadyStateCheck == false}}

    traffic_shift:
      type: boolean
      label: Use traffic shift
      default: false
      ui:
        component: boolean-card-select
        tooltip: Flag to enable traffic shift for blue-green deployment
    provider:
      type: string
      label: Provider
      default: istio
      options:
        - istio
        - k8s-native
      ui:
        component: select
        tooltip: Select the traffic shift provider
        visible: ${{trafficShift == true}}
    resource_name:
      type: string
      label: Resource Name
      default: traffic-split-${{service.name}}
      ui:
        tooltip: Enter the name of the Kubernetes resource (auto-generated if not provided)
        visible: ${{trafficShift == true}}
    hosts:
      type: array
      label: Hosts
      ui:
        component: array
        input:
          inputType: text
        tooltip: Comma separated list of host names
        placeholder: hostname
        visible: ${{trafficShift == true}}
    gateways:
      type: array
      label: Gateways
      ui:
        component: array
        input:
          inputType: text
        tooltip: Comma separated list of gateway names or fully qualified names
        placeholder: gateway name
        visible: ${{trafficShift == true}}
    routes:
      type: string
      label: Configure Routes
      ui:
        component: textarea
        tooltip: Enter the JSON string of the traffic shift routes configuration
        placeholder: '[{"name":"route1","destinations":[{"host":"svc","weight":60},{"host":"svc-canary","weight":40}]}]'
        visible: ${{trafficShift == true}}
    traffic_shift_timeout:
      type: string
      label: Traffic Shift command timeout
      default: 5m
      ui:
        tooltip: Enter the timeout for the traffic shift command
        visible: ${{trafficShift == true}}

  layout:
    - title: Optional Configuration
      items:
        - kubeconfig
        - manifests
        - namespace
        - release
        - service_id
        - environment_id
        - infra_id
        - infra_key
        - manifest_output_path
        - provider
        - resource_name
        - hosts
        - gateways
        - routes
        - flags
        - apply_timeout
        - steady_state_timeout
        - traffic_shift_timeout
        - log_level
        - skip_resource_versioning
        - skip_unchanged_manifest
        - skip_dry_run
        - pruning
        - print_manifests
        - server_side_apply
        - encrypt_yaml_output
        - skip_steady_state_check
        - describe_resources
        - traffic_shift
  id: k8sBlueGreenDeployStep
  name: Kubernetes Blue Green Deploy
  description: Creates the Kubernetes services and pod sets needed for new app versions and deploys the new version to the pod set receiving stage traffic
  version: 1
  author: harness
  module:
    - cd
  alias: deploy
  step:
    group:
      steps:
        - name: Kubernetes Blue Green Prepare
          id: k8sBlueGreenPrepare
          run:
            container:
              image: harnessdev/k8s-bluegreen:0.0.1
              connector: account.harnessImage
            env:
              PLUGIN_KUBECONFIG_PATH: ${{inputs.kubeconfig}}
              PLUGIN_RELEASE_NAME: ${{inputs.release}}
              PLUGIN_SERVICE_ID: ${{inputs.service_id}}
              PLUGIN_ENVIRONMENT_ID: ${{inputs.environment_id}}
              PLUGIN_INFRA_ID: ${{inputs.infra_id}}
              PLUGIN_INFRA_KEY: ${{inputs.infra_key}}
              PLUGIN_MANIFEST_PATH: ${{inputs.manifests}}
              PLUGIN_MANIFEST_OUTPUT_PATH: ${{inputs.manifest_output_path}}
              PLUGIN_NAMESPACE: ${{inputs.namespace}}
              PLUGIN_SKIP_RESOURCE_VERSIONING: ${{inputs.skip_resource_versioning}}
              PLUGIN_SKIP_UNCHANGED_MANIFEST: ${{inputs.skip_unchanged_manifest}}
              PLUGIN_FF_CDS_SUPPORT_HPA_AND_PDB_NG: ${{runtime.ff.CDS_SUPPORT_HPA_AND_PDB_NG}}
              PLUGIN_LOG_LEVEL: ${{inputs.log_level}}
        - name: Kubernetes Apply
          id: k8sApplyStep
          run:
            container:
              image: harnessdev/k8s-apply:0.0.1
              connector: account.harnessImage
            env:
              PLUGIN_KUBECONFIG_PATH: ${{inputs.kubeconfig}}
              PLUGIN_NAMESPACE: ${{inputs.namespace}}
              PLUGIN_MANIFEST_PATH: ${{${{runtime.fqn}}.k8sBlueGreenPrepare.output.outputVariables.PLUGIN_MANIFEST_OUTPUT_PATH}}
              PLUGIN_SKIP_DRY_RUN: ${{inputs.skip_dry_run}}
              PLUGIN_RELEASE_PRUNING_ENABLED: ${{inputs.pruning}}
              PLUGIN_SERVER_SIDE_APPLY: ${{inputs.server_side_apply}}
              PLUGIN_RELEASE_NAME: ${{inputs.release}}
              PLUGIN_RELEASE_NUMBER: ${{${{runtime.fqn}}.k8sBlueGreenPrepare.output.outputVariables.PLUGIN_RELEASE_NUMBER}}
              PLUGIN_SERVICE_ID: ${{inputs.service_id}}
              PLUGIN_ENVIRONMENT_ID: ${{inputs.environment_id}}
              PLUGIN_INFRA_ID: ${{inputs.infra_id}}
              PLUGIN_INFRA_KEY: ${{inputs.infra_key}}
              PLUGIN_PRINT_MANIFESTS: ${{inputs.print_manifests}}
              PLUGIN_ENCRYPT_YAML_OUTPUT: ${{inputs.encrypt_yaml_output}}
              PLUGIN_FLAGS_JSON: ${{json.format(${{inputs.flags}})}}
              PLUGIN_EXECUTE_DRY_RUN: false
              PLUGIN_LOG_LEVEL: ${{inputs.log_level}}
              PLUGIN_TIMEOUT: ${{inputs.apply_timeout}}
        - if: ${{inputs.skip_steady_state_check == false}}
          name: K8s Steady State Check Step
          id: k8sApplySteadyStateCheckStep
          template:
            uses: k8sSteadyStateCheckStep@1.0.0
            with:
              kubeconfig: ${{inputs.kubeconfig}}
              release: ${{inputs.release}}
              service_id: ${{inputs.service_id}}
              environment_id: ${{inputs.environment_id}}
              infra_id: ${{inputs.infra_id}}
              infra_key: ${{inputs.infra_key}}
              describe_resources: ${{inputs.describe_resources}}
              namespace: ${{inputs.namespace}}
              is_openshift: ${{${{runtime.fqn}}.k8sApplyStep.output.outputVariables.HARNESS_IS_OPENSHIFT}}
              existing_pods: ${{${{runtime.fqn}}.k8sApplyStep.output.outputVariables.PLUGIN_EXISTING_PODS}}
              release_number: ${{${{runtime.fqn}}.k8sApplyStep.output.outputVariables.PLUGIN_RELEASE_NUMBER}}
              custom_workloads: ${{${{runtime.fqn}}.k8sApplyStep.output.outputVariables.PLUGIN_CUSTOM_WORKLOADS}}
              managed_workloads: ${{${{runtime.fqn}}.k8sApplyStep.output.outputVariables.PLUGIN_MANAGED_WORKLOADS}}
              manifest: ${{${{runtime.fqn}}.k8sApplyStep.output.outputVariables.PLUGIN_MANIFEST_OUTPUT_FILE_PATH}}
              timeout: ${{inputs.steady_state_timeout}}
        - if: ${{inputs.traffic_shift == true}}
          name: K8s Traffic Shift 
          id: k8sTrafficShift
          template:
            uses: k8sTrafficRoutingStep@1.0.0
            with:
              kubeconfig: ${{inputs.kubeconfig}}
              provider: ${{inputs.provider}}
              config_type: new
              gateways: ${{inputs.gateways}}
              hosts: ${{inputs.hosts}}
              resource_name: ${{inputs.resource_name}}
              routes: ${{inputs.routes}}
              namespace: ${{inputs.namespace}}
              release: ${{inputs.release}}
              release_number: ${{${{runtime.fqn}}.k8sBlueGreenPrepare.output.outputVariables.PLUGIN_RELEASE_NUMBER}} 
              service_id: ${{inputs.service_id}}
              environment_id: ${{inputs.environment_id}}
              infra_id: ${{inputs.infra_id}}
              infra_key: ${{inputs.infra_key}}
              server_side_apply: ${{inputs.server_side_apply}}
              prepare_only: false
              manifest_output_path: ${{inputs.manifest_output_path}}
              timeout: ${{inputs.traffic_shift_timeout}}
              is_openshift: ${{${{runtime.fqn}}.k8sApplyStep.output.outputVariables.HARNESS_IS_OPENSHIFT}}
              log_level: ${{inputs.log_level}}
