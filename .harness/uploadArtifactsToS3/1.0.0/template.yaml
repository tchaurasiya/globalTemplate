template:
  inputs:
    connector:
      type: connector
      label: AWS Connector
      required: true
      oneof:
        - Aws
      ui:
        tooltip: Select the Harness AWS Connector to use when connecting to AWS S3. The AWS IAM roles and policies associated with the account used in the Harness AWS Connector must be able to push to S3.
        allowedValueTypes:
          - fixed
          - runtime
          - expression
    endpoint:
      type: string
      label: Endpoint URL
      ui:
        component: string
        placeholder: http://minio.company.com
        tooltip: Enter the endpoint for S3-compatible providers. Not needed for AWS.
        allowedValueTypes:
          - fixed
          - runtime
          - expression
    bucket:
      type: string
      label: Bucket
      required: true
      ui:
        component: string
        tooltip: Enter the name of the S3 bucket where you want to upload the artifact.
        allowedValueTypes:
          - fixed
          - runtime
          - expression
    region:
      type: string
      label: Region
      required: true
      ui:
        component: string
        tooltip: Enter the relevant AWS region.
        placeholder: us-east-1
        allowedValueTypes:
          - fixed
          - runtime
          - expression
    source:
      type: string
      label: Source Path
      required: true
      ui:
        component: string
        tooltip: Enter the path to the artifact file/folder to upload.
        allowedValueTypes:
          - fixed
          - runtime
          - expression
    target:
      type: string
      label: Target
      ui:
        component: string
        placeholder: path/in/bucket
        tooltip: Enter the path, relative to the bucket, where you want to store the cache/artifact. Do not include the bucket name; you specified this in the Bucket field. If no path is specified, the cache/artifact is saved to [bucket]/[key].
        allowedValueTypes:
          - fixed
          - runtime
          - expression
    stripprefix:
      type: string
      ui:
        component: ghost
    image:
      type: string
      label: Image
      default: plugins/s3
      ui:
        component: string
        tooltip: Specify the container image for the step.
        allowedValueTypes:
          - fixed
          - runtime
          - expression
  layout:
    - connector
    - region
    - bucket
    - source
    - title: Optional Configuration
      items:
        - endpoint
        - target
        - image
  id: uploadArtifactsToS3
  name: Upload Artifacts to S3
  description: Upload artifacts to AWS S3.
  version: 1
  author: harness
  module:
    - ci
  alias: build
  step:
    group:
      steps:
        - id: s3Upload
          name: s3Upload
          run:
            container:
              image: ${{inputs.image}}
            with:
              ENDPOINT: ${{inputs.endpoint}}
              ACCESS_KEY: ${{${{inputs.connector}}.accessKey}}
              SECRET_KEY: ${{${{inputs.connector}}.secretKey}}
              ASSUME_ROLE: ${{${{inputs.connector}}.assumeRole}}
              BUCKET: ${{inputs.bucket}}
              REGION: ${{inputs.region}}
              SOURCE: ${{inputs.source}}
              TARGET: ${{inputs.target}}
              STRIP_PREFIX: ${{inputs.stripprefix}}
              OIDC_TOKEN_ID: ${{${{inputs.connector}}.oidcTokenId}}