template:
  inputs:
    duration:
      type: string
      label: Duration
      default: "10"
      required: true
      ui:      
        tooltip: Verification duration in minutes (applied to both baseline and verification windows)
        placeholder: Enter duration in minutes
        allowedValueTypes:
          - fixed
          - runtime
          - expression
    sensitivity:
      type: select
      label: Sensitivity
      default: Medium
      required: true
      options:
        - Low
        - Medium
        - High
      ui:
        tooltip: Sensitivity level for anomaly detection
    fail_no_data:
      type: boolean
      label: Fail on No Analysis
      default: true
      ui:
        tooltip: Fail the step if no analysis data is available
    fail_metric:
      type: boolean
      label: Fail if Any Metric in No Analysis
      default: true
      ui:
        tooltip: Fail the step if any metric has no analysis data
    control_regex:
      type: string
      label: Control Node RegEx Pattern
      ui:
        tooltip: Regular expression pattern to identify control nodes
        placeholder: .*primary.*
        allowedValueTypes:
          - fixed
          - runtime
          - expression
    test_regex:
      type: string
      label: Test Node RegEx Pattern
      ui:
        tooltip: Regular expression pattern to identify test nodes
        placeholder: .*canary.*
        allowedValueTypes:
          - fixed
          - runtime
          - expression
    baseline_end:
      type: string
      label: Baseline End Time 
      default: ${{ stage.startTs }}
      required: true
      ui:      
        tooltip: End time of the pre-deployment analysis window
        placeholder: Enter timestamp
        allowedValueTypes:
          - fixed
          - runtime
          - expression
    verify_start:
      type: string
      label: Verification Start Time 
      # startTs expression doesn't work in same steps
      default: ${{ steps.mapHealthSourcetoImage.endTs }}
      required: true
      ui:      
        tooltip: Start time of the post-deployment analysis window
        placeholder: Enter timestamp
        allowedValueTypes:
          - fixed
          - runtime
          - expression       
    context:
      type: string
      label: Configuration Context
      ui:
        tooltip: Natural language context for what to monitor
        allowedValueTypes:
          - fixed
          - runtime
          - expression
    service:
      type: string
      label: Service
      default: ${{service.identifier}}
      ui:
        tooltip: Service Identifier
        allowedValueTypes:
          - fixed
          - runtime
          - expression
    env:
      type: string
      label: Environment
      default: ${{ infra.environment.identifier }}
      ui:
        tooltip: Environment Identifier
        allowedValueTypes:
          - fixed
          - runtime
          - expression
    infra:
      type: string
      label: Infrastructure
      default: ${{ infra.identifier }}
      ui:
        tooltip: Infrastructure Identifier
        allowedValueTypes:
          - fixed
          - runtime
          - expression
    health_sources:
      type: array
      label: Health Source References
      required: true
      ui:
        component: array
        tooltip: List of health source identifiers to verify. Click '+' to add additional health sources.
        input:
          # replace this with type healthsource when UI component is ready
          inputType: text   
  layout:
    - title: Configuration
      items:
        - duration
        - sensitivity
        - fail_no_data
        - fail_metric
        - control_regex
        - test_regex
        - baseline_end
        - verify_start                  
        - context
      required: true  
    - title: Target
      items:
        - service
        - env
        - infra
    - title: Health Sources
      items:
        - health_sources
      required: true   
  id: aiVerify
  name: AI Verify
  description: AI-Based Verification for continuous deployment with intelligent anomaly detection and log analysis
  version: 1
  author: harness
  module:
    - cv
  alias: verify
  step:
    group:
      steps:
        - name: mapHealthSourcetoImage
          id: mapHealthSourcetoImage
          run:
            shell: bash
            script: |-
                  #!/bin/sh
                  echo "Health Source Type: $PLUGIN_HEALTHSOURCE_TYPE"
                  if [ "$PLUGIN_HEALTHSOURCE_TYPE" = "DatadogMetrics" ]; then
                      export IMAGE="harnessdev/ai-verify-plugin:1.1.1"
                      export TOPIC_NAME="ai-verify-metrics-data"
                  elif [ "$PLUGIN_HEALTHSOURCE_TYPE" = "DynatraceGrailLogs" ]; then
                      export IMAGE="harnessdev/ai-verify-plugin-log:1.1.1"
                      export TOPIC_NAME="ai-verify-logs-data"
                  else
                      export IMAGE="harnessdev/ai-verify-plugin-log:1.1.1"
                      export TOPIC_NAME="ai-verify-logs-data"
                  fi

                  echo "Using image: $IMAGE for health source"
                  echo "Using kafka topic: $TOPIC_NAME for health source"
            env:
              PLUGIN_HARNESS_HEALTHSOURCE: <+matrix.healthSourceRef>
            output: 
              - name: IMAGE
                alias: image
              - name: TOPIC_NAME
                alias: topic_name
        - name: AI Verify
          id: aiVerify
          type: Verify
          run:
            container:
              image: <+steps.mapHealthSourcetoImage.output.outputVariables.image>
              connector: account.harnessImage
            env:
              PLUGIN_DURATION: ${{inputs.duration}}
              PLUGIN_SENSITIVITY: ${{inputs.sensitivity}}
              PLUGIN_FAIL_ON_NO_ANALYSIS: ${{inputs.fail_no_data}}
              PLUGIN_FAIL_IF_ANY_CUSTOM_METRIC_IN_NO_ANALYSIS: ${{inputs.fail_metric}}
              PLUGIN_CONTROL_NODE_REGEX_PATTERN: ${{inputs.control_regex}}
              PLUGIN_TEST_NODE_REGEX_PATTERN: ${{inputs.test_regex}}
              PLUGIN_BASELINE_END_TIME: ${{inputs.baseline_end}}
              PLUGIN_VERIFICATION_START_TIME: ${{inputs.verify_start}}              
              PLUGIN_CONFIGURATION_CONTEXT: ${{inputs.context}}
              PLUGIN_SERVICE_REF: ${{inputs.service}}
              PLUGIN_ENVIRONMENT_REF: ${{inputs.env}}
              PLUGIN_INFRASTRUCTURE_REF: ${{inputs.infra}}
              PLUGIN_HARNESS_HEALTHSOURCE: <+matrix.healthSourceRef>
              PLUGIN_HARNESS_LOG_SERVICE_CUSTOM_KAFKA_TOPIC: <+steps.mapHealthSourcetoImage.output.outputVariables.topic_name>
    strategy:
            matrix:
              healthSourceRef: ${{inputs.health_sources}}