template:
  inputs:
    connector:
      type: connector
      label: AWS connector
      required: true
      default: ${{infra.connector}}
      oneof:
        - Aws
      ui:
        tooltip: Select the Harness AWS Connector for the AWS account where you want to perform ECS Bluegreen deployment
        placeholder: Select AWS Connector
    cluster:
      type: string
      label: Cluster
      required: true
      default: ${{infra.cluster}}
      ui:
        component: string
        tooltip: Enter the AWS cluster name where the ECS service is deployed
    region:
      type: string
      label: Region
      required: true
      default: ${{infra.region}}
      ui:
        component: string
        placeholder: us-east-1
        tooltip: Enter the AWS region where the ECS cluster is located
    log_level:
      type: string
      label: Log level
      default: info
      options:
        - warn
        - error
        - info
        - debug
        - trace
      ui:
        component: select
        tooltip: Set the log level for the step
    blue_service:
      type: string
      label: Blue (old) service name
      required: true
      default: ${{rollback.data.SERVICE_NAME}}
      ui:
        component: string
        tooltip: Enter the name of the blue (old) service
        placeholder: Please enter blue (old) service name
        visible: ${{firstDeployment == false}}
    green_service:
      type: string
      label: Green (new) service name
      required: true
      default: ${{rollback.data.GREEN_SERVICE_NAME}}
      ui:
        component: string
        tooltip: Enter the name of the green (new) service
        placeholder: Please enter green (new) service name
    first_deployment:
      type: boolean
      label: Is first deployment
      default: ${{rollback.data.FIRST_DEPLOYMENT}}
      ui:
        component: boolean-card-select
        tooltip: Indicate whether the deployment was a first deployment
    new_service_created:
      type: boolean
      label: Was new service created
      default: ${{rollback.data.NEW_SERVICE_CREATED}}
      ui:
        component: boolean-card-select
        tooltip: Indicate whether a new service was created
    traffic_shift_started:
      type: boolean
      label: Has traffic shift started
      default: ${{rollback.data.TRAFFIC_SHIFT_STARTED}}
      ui:
        component: boolean-card-select
        tooltip: Indicate whether traffic shift has started
    blue_service_json:
      type: string
      label: Blue (old) service json
      required: true
      default: ${{rollback.data.SERVICE_JSON}}
      ui:
        component: string
        tooltip: Enter the blue (old) service configuration as a JSON string
        placeholder: Please insert json of blue (old) service
        visible: ${{firstDeployment == false}}
    blue_service_scalable_targets_json:
      type: string
      label: Blue (old) service scalable targets json
      default: ${{rollback.data.SCALABLE_TARGETS_JSON}}
      ui:
        component: string
        tooltip: Enter the blue (old) service scalable targets as a JSON string array
        placeholder: Please insert json of blue (old) service scalable targets
    blue_service_scaling_policies_json:
      type: string
      label: Blue (old) service scaling policies json
      default: ${{rollback.data.SCALING_POLICIES_JSON}}
      ui:
        component: string
        tooltip: Enter the blue (old) service scaling policies as a JSON string array
        placeholder: Please insert json of blue (old) service scaling policies
    green_service_existed:
      type: boolean
      label: Has green service existed
      default: ${{rollback.data.GREEN_SERVICE_EXIST}}
      ui:
        component: boolean-card-select
        tooltip: Indicate whether the green service previously existed
    green_service_json:
      type: string
      label: Green (new) service json
      required: true
      default: ${{rollback.data.GREEN_SERVICE_JSON}}
      ui:
        component: string
        tooltip: Enter the green (new) service configuration as a JSON string
        placeholder: Please insert json of green (new) service
        visible: ${{firstDeployment == false}}
    green_service_scalable_targets_json:
      type: string
      label: Green (new) service scalable targets json
      default: ${{rollback.data.GREEN_SERVICE_SCALABLE_TARGETS_JSON}}
      ui:
        component: string
        tooltip: Enter the green (new) service scalable targets as a JSON string array
        placeholder: Please insert json of green (new) service scalable targets
    green_service_scaling_policies_json:
      type: string
      label: Green (new) service scaling policies json
      default: ${{rollback.data.GREEN_SERVICE_SCALING_POLICIES_JSON}}
      ui:
        component: string
        tooltip: Enter the green (new) service scaling policies as a JSON string array
        placeholder: Please insert json of green (new) service scaling policies
    rollback_green_service:
      type: boolean
      label: Rollback green service
      default: ${{rollback.data.GREEN_SERVICE_ROLLBACK_DATA_EXIST}}
      ui:
        component: boolean-card-select
        tooltip: Enable this option to rollback the green service
    skip_steady_state:
      type: boolean
      label: Skip steady state check
      default: false
      ui:
        component: boolean-card-select
        tooltip: Turn on to skip steady state check 
    steady_state_timeout:
      type: string
      label: Steady state check command timeout
      default: 10m
      ui:
        tooltip: Specify the timeout to use during steady state check process
        visible: ${{skipSteadyState == false}}
    load_balancer:
      type: string
      label: Elastic Load balancer
      required: true
      default: ${{rollback.data.LOAD_BALANCER}}
      ui:
        tooltip: Enter the name of the Elastic Load Balancer
        placeholder: Please enter load balancer name
    traffic_shift:
      type: boolean
      label: Use Shift Traffic
      default: ${{rollback.data.IS_TRAFFIC_SHIFT}}
      ui:
        component: boolean-card-select
        tooltip: Enable this checkbox to activate traffic shifting for the ECS Blue Green deployment. When selected, traffic will be gradually shifted between target groups based on the weight percentages you define. If not selected, the deployment will follow the standard Blue Green process, swapping traffic 100% between the production and stage target groups.
    prod_listener_arn:
      type: string
      label: Prod listener
      required: true
      default: ${{rollback.data.PROD_LISTENER_ARN}}
      ui:
        tooltip: Select the ELB listener that you want to use as the Prod Listener.
        placeholder: Please enter ARN of Prod listener
    prod_listener_rule_arn:
      type: string
      label: Prod listener rule ARN
      default: ${{rollback.data.PROD_LISTENER_RULE_ARN}}
      ui:
        tooltip: If you do not enter a listener rule, Harness uses the Default rule.
        placeholder: Please enter ARN of Prod listener rule
    prod_target_group_arn:
      type: string
      label: Prod listener target group
      required: true
      default: ${{rollback.data.PROD_TARGET_GROUP_ARN}}
      ui:
        tooltip: Enter the target group for prod deployment
        placeholder: Please enter ARN of Prod listener target group
    stage_listener_arn:
      type: string
      label: Stage listener
      required: true
      default: ${{rollback.data.STAGE_LISTENER_ARN}}
      ui:
        tooltip: Select the ELB listener that you want to use as the Stage Listener.
        placeholder: Please enter ARN of Stage listener
    stage_listener_rule_arn:
      type: string
      label: Stage listener rule ARN
      default: ${{rollback.data.STAGE_LISTENER_RULE_ARN}}
      ui:
        tooltip: If you do not enter a listener rule, Harness uses the Default rule.
        placeholder: Please enter ARN of Stage listener rule
    stage_target_group_arn:
      type: string
      label: Stage listener target group
      required: true
      default: ${{rollback.data.STAGE_TARGET_GROUP_ARN}}
      ui:
        tooltip: Enter the target group for stage deployment
        placeholder: Please enter ARN of Stage listener target group
  layout:
    - connector
    - region
    - cluster
    - green_service
    - blue_service
    - blue_service_json
    - green_service_json
    - load_balancer
    - prod_listener_arn
    - prod_target_group_arn
    - stage_listener_arn
    - stage_target_group_arn
    - title: Optional Configuration
      items:
        - first_deployment
        - new_service_created
        - traffic_shift_started
        - blue_service_scalable_targets_json
        - blue_service_scaling_policies_json
        - green_service_existed
        - green_service_scalable_targets_json
        - green_service_scaling_policies_json
        - rollback_green_service
        - traffic_shift
        - prod_listener_rule_arn
        - stage_listener_rule_arn
        - skip_steady_state
        - steady_state_timeout
        - log_level
  id: ecsBluegreenRollbackStep
  name: ECS BlueGreen Rollback Step
  description: Executes an ECS BlueGreen rollback
  version: 1
  author: harness
  module:
    - cd
  alias: bg-rollback
  step:
    group:
      steps:
        - name: bluegreenrollback
          id: bluegreenrollback
          run:
            container:
              image: harnessdev/ecs-bluegreen-rollback:0.0.1
              connector: account.harnessImage
            env:
              PLUGIN_HARNESS_CONNECTOR: ${{inputs.connector.id}}
              PLUGIN_LOG_LEVEL: ${{inputs.log_level}}
              PLUGIN_CLUSTER: ${{inputs.cluster}}
              PLUGIN_REGION: ${{inputs.region}}
              PLUGIN_BLUE_SERVICE: ${{inputs.blue_service}}
              PLUGIN_GREEN_SERVICE: ${{inputs.green_service}}
              PLUGIN_FIRST_DEPLOYMENT: ${{inputs.first_deployment}}
              PLUGIN_NEW_SERVICE_CREATED: ${{inputs.new_service_created}}
              PLUGIN_TRAFFIC_SHIFT_STARTED: ${{inputs.traffic_shift_started}}
              PLUGIN_BLUE_SERVICE_JSON: ${{inputs.blue_service_json}}
              PLUGIN_BLUE_SERVICE_SCALABLE_TARGETS_JSON: ${{inputs.blue_service_scalable_targets_json}}
              PLUGIN_BLUE_SERVICE_SCALING_POLICIES_JSON: ${{inputs.blue_service_scaling_policies_json}}
              PLUGIN_GREEN_SERVICE_EXISTED: ${{inputs.green_service_existed}}
              PLUGIN_GREEN_SERVICE_JSON: ${{inputs.green_service_json}}
              PLUGIN_GREEN_SERVICE_SCALABLE_TARGETS_JSON: ${{inputs.green_service_scalable_targets_json}}
              PLUGIN_GREEN_SERVICE_SCAING_POLICIES_JSON: ${{inputs.green_service_scaling_policies_json}}
              PLUGIN_ROLLBACK_GREEN_SERVICE: ${{inputs.rollback_green_service}}
              PLUGIN_STEADY_STATE_CHECK: ${{inputs.skip_steady_state}}
              PLUGIN_STEADY_STATE_CHECK_TIMEOUT: ${{inputs.steady_state_timeout}}
              PLUGIN_LOAD_BALANCER: ${{inputs.load_balancer}}
              PLUGIN_STAGE_LISTENER_ARN: ${{inputs.stage_listener_arn}}
              PLUGIN_STAGE_LISTENER_RULE_ARN: ${{inputs.stage_listener_rule_arn}}
              PLUGIN_STAGE_TARGET_GROUP_ARN: ${{inputs.stage_target_group_arn}}
              PLUGIN_PROD_LISTENER_ARN: ${{inputs.prod_listener_arn}}
              PLUGIN_PROD_LISTENER_RULE_ARN: ${{inputs.prod_listener_rule_arn}}
              PLUGIN_PROD_TARGET_GROUP_ARN: ${{inputs.prod_target_group_arn}}
              PLUGIN_TRAFFIC_SHIFT: ${{inputs.traffic_shift}}