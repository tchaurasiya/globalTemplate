template:
  inputs:
    kubeconfig:
      type: string
      label: Kubeconfig Path
      default: ${{infra.PLUGIN_HARNESS_KUBE_CONFIG_PATH}}
      ui:
        tooltip: Enter the path to your kubeconfig file
    namespace:
      type: string
      label: Namespace
      default: ${{infra.namespace}}
      ui:
        tooltip: Enter the Kubernetes namespace for this deployment
    workload:
      type: string
      label: Workload
      required: true
      ui:
        tooltip: Enter the workload in format ns/kind/name.
        placeholder: ns/kind/name
    instances:
      type: number
      default: 1
      label: Instances
      ui:
        component: number
        tooltip: Enter the number of instances to scale to
    unittype:
      type: string
      default: count
      label: Instances Unit Type
      options:
        - count
        - percentage
      ui:
        component: select
        tooltip: Select the unit type for instances (count or percentage)
    release:
      type: string
      label: Release Name
      default: ${{infra.release}}
      ui:
        tooltip: Enter the name for this Harness release
    flags:
      type: array
      label: Command Flags
      ui:
        component: list
        layout: grid
        inputs:
          - inputType: select
            relativePath: commandType
            label: Command Type
            inputConfig:
              options:
                - label: Describe
                  value: Describe
          - inputType: textarea
            relativePath: flag
            label: Flag
            ui:
              placeholder: --warnings-as-errors
    skip_steady_state_check:
      type: boolean
      label: Skip Steady State Check
      default: false
      ui:
        component: boolean-card-select
        tooltip: Skip the steady state check
    describe_resources:
      type: boolean
      label: Describe Resources
      default: false
      ui:
        component: boolean-card-select
        tooltip: Flag to describe resources in the steady state check
        visible: ${{skipSteadyStateCheck == false}}
    log_level:
      type: string
      label: Log Level
      default: info
      options:
        - warn
        - error
        - info
        - debug
        - trace
      ui:
        component: select
        tooltip: Select the log level for this step
    scale_timeout:
      type: string
      label: Scale command timeout
      default: 5m
      ui:
        tooltip: Enter the timeout for the scale command
    steady_state_timeout:
      type: string
      label: Steady state command timeout
      default: 5m
      ui:
        tooltip: Enter the timeout for the steady state check
        visible: ${{skipSteadyStateCheck == false}}
    is_openshift:
      type: boolean
      label: OpenShift Mode
      default: false
      ui:
        component: boolean-card-select
        tooltip: Flag to mark if this is OpenShift deployment
  layout:
    - workload
    - title: Optional Configuration
      items:
        - kubeconfig
        - namespace
        - unittype
        - instances
        - release
        - flags
        - scale_timeout
        - steady_state_timeout
        - log_level
        - skip_steady_state_check
        - describe_resources
        - is_openshift
  id: k8sScaleStep
  name: Kubernetes Scale
  description: Scales a Kubernetes workload to the specified number of instances
  version: 1
  author: harness
  module:
    - cd
  alias: deploy
  step:
    group:
      steps:
        - name: K8s Scale Step
          id: k8sScaleStep
          run:
            container:
              image: harnessdev/k8s-scale:0.0.1
              connector: account.harnessImage
            env:
              PLUGIN_KUBECONFIG_PATH: ${{inputs.kubeconfig}}
              PLUGIN_WORKLOAD: ${{inputs.workload}}
              PLUGIN_INSTANCES: ${{inputs.instances}}
              PLUGIN_INSTANCES_UNIT_TYPE: ${{inputs.unittype}}
              PLUGIN_NAMESPACE: ${{inputs.namespace}}
              PLUGIN_RELEASE_NAME: ${{inputs.release}}
              PLUGIN_LOG_LEVEL: ${{inputs.log_level}}
              PLUGIN_TIMEOUT: ${{inputs.scale_timeout}}
              HARNESS_IS_OPENSHIFT: ${{inputs.is_openshift}}
        - if: ${{inputs.skip_steady_state_check == false}}
          name: Kubernetes Steady State Check Step
          id: k8sScaleSteadyStateCheckStep
          template:
            uses: k8sSteadyStateCheckStep@1.0.0
            with:
              kubeconfig: ${{inputs.kubeconfig}}
              release: ${{inputs.release}}
              describe_resources: ${{inputs.describe_resources}}
              namespace: ${{inputs.namespace}}
              is_openshift: ${{inputs.is_openshift}}
              managed_workloads: ${{inputs.workload}}
              existing_pods: ${{${{runtime.fqn}}.k8sScaleStep.output.outputVariables.PLUGIN_PODS}}
              timeout: ${{inputs.steady_state_timeout}}
              flags: ${{inputs.flags}}
