template:
  id: RestoreCacheFromHarness
  name: RestoreCacheFromHarness
  version: 1
  inputs:
    connector:
      type: connector
      value: <+runtime.settings.ci_cache_connector>
    cacheKey:
      type: string
      value: <+stage.cacheIntelligence.key>
    endpoint:
      type: string
      value: <+runtime.settings.ci_cache_s3_endpoint_url>
    bucket:
      type: string
      value: <+runtime.settings.ci_cache_s3_bucket_name>
    region:
      type: string
      value: <+runtime.settings.ci_cache_s3_region>
  step:
    group:
      steps:
        - if: <+<+stage.runtime>.cloud == null>
          id: restoreCacheFromHarness
          name: restoreCacheFromHarness
          run:
            container:
              image: plugins/cache:1.8.1
            with:
              CACHE_KEY: <+inputs.cacheKey>
              RESTORE: true
              ENDPOINT: <+inputs.endpoint>
              REGION: <+inputs.region>
              ARCHIVE_FORMAT: tar
              FAIL_RESTORE_IF_KEY_NOT_PRESENT: false
              EXIT_CODE: true
              BACKEND: <+runtime.inputs.PLUGIN_BACKEND>
              BACKEND_OPERATION_TIMEOUT: 100000s
              BUCKET: <+inputs.bucket>
              ACCESS_KEY: <+<+inputs.connector>.accessKey>
              SECRET_KEY: <+<+inputs.connector>.secretKey>
          on-failure:
            errors: all
            action: success
        - if: <+<+stage.runtime>.cloud != null>
          id: restoreCachefromHarness
          name: restoreCachefromHarness
          run:
            container:
              image: plugins/cache
            with:
              CACHE_KEY: <+inputs.cacheKey>
              RESTORE: true
              ARCHIVE_FORMAT: tar
              FAIL_RESTORE_IF_KEY_NOT_PRESENT: false
              EXIT_CODE: true
              BACKEND_OPERATION_TIMEOUT: 100000s
              ACL: private
              AUTO_CACHE: true
          on-failure:
            errors: all
            action: success