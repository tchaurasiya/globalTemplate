template:
  inputs:
    # ServiceNow Connector
    connector:
      type: connector
      label: ServiceNow connector
      required: true
      oneof:
        - ServiceNow
      ui:
        tooltip: Select the ServiceNow connector for authentication
        allowedValueTypes:
          - fixed
          - runtime
          - expression
    ticket_type:
      type: string
      label: Ticket type
      required: true
      ui:
        tooltip: Specify the type of ServiceNow ticket to monitor for approval
        placeholder: Enter ticket type
    ticket_number:
      type: string
      label: Ticket number
      required: true
      ui:
        tooltip: Enter the ticket number to monitor for approval
        placeholder: Enter ticket number
    retry:
      type: string
      label: Retry interval
      default: 1m
      ui:
        tooltip: Specify the interval between retry attempts for checking approval status
        placeholder: Enter retry interval
    approve:
      type: string
      label: Approve Criteria
      ui:
        tooltip: Define the conditions or expression that will approve the deployment
        placeholder: Enter conditions or expression
    reject:
      type: string
      label: Reject Criteria
      ui:
        tooltip: Define the conditions or expression that will reject the deployment
        placeholder: Enter conditions or expression
    start:
      type: string
      label: Change window start
      ui:
        tooltip: Specify the window in which Harness will proceed with the deployment. Once this step is approved, Harness will not proceed with deployment unless the current time is within this window. The start time uses the time zone set in the ServiceNow account selected in the Connector.
        placeholder: Enter change window start
    end:
      type: string
      label: Change window end
      ui:
        tooltip: Specify the window in which Harness will proceed with the deployment. Once this step is approved, Harness will not proceed with deployment unless the current time is within this window. The start time uses the time zone set in the ServiceNow account selected in the Connector.
        placeholder: Enter change window end
    log_level:
      type: string
      label: Log level
      default: error
      options:
        - info
        - warn
        - error
        - debug
        - trace
      ui:
        component: select
        tooltip: Set the log level for the plugin.

  layout:
    - connector
    - ticket_type
    - ticket_number
    - retry
    - title: Approve Criteria
      items:
      - approve
    - title: Optional Configuration
      items:
      - title: Reject Criteria
        items:
        - reject
      - title: Change Window
        items:
        - start
        - end
    - log_level
  id: servicenow_approval
  name: ServiceNow Approval
  description: Approve or reject a ticket in ServiceNow
  version: 1
  author: harness
  module:
    - cd
  alias: deploy
  step:
    group:
      steps:
        - approval:
          uses: servicenow
          with:
            retry: ${{inputs.retry}}
            change-window:
              start: ${{inputs.start}}
              end: ${{inputs.end}}
            run:
              download:
                source: https://storage.googleapis.com/unified-plugins/servicenow-approval/v0.0.1/
                target: $PLUGIN_PATH
              script: $PLUGIN_PATH
              env:
                PLUGIN_HARNESS_CONNECTOR: ${{inputs.connector.id}}
                PLUGIN_LOG_LEVEL: ${{inputs.log_level}}
                PLUGIN_TICKET_TYPE: ${{inputs.ticket_type}}
                PLUGIN_TICKET_NUMBER: ${{inputs.ticket_number}}
            approve: ${{inputs.approve}}
            reject: ${{inputs.reject}}
