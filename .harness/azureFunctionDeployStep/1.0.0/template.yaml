template:
  inputs:
    infra:
      type: connector
      label: Infra Connector
      required: true
      default: ${{infra.connector}} 
      oneof:
        - Azure
      ui:
        tooltip: Azure connector
        allowedValueTypes:
          - fixed
          - runtime
          - expression 
    artifact:
      type: connector
      label: Artifact connector
      required: true
      default: ${{service.artifacts.primary.connector}} 
      oneof:
        - Azure
        - Docker
        - Nexus
        - Artifactory
      ui:
        tooltip: Artifact connector
        allowedValueTypes:
          - fixed
          - runtime
          - expression       
    app:
      type: string
      label: Function app name
      required: true
      ui:
        tooltip: The name of the Azure Function App to deploy to
        placeholder: enter function app 

    slot:
      type: string
      label: Deployment slot
      required: true
      ui:
        tooltip: Deployment slot to deploy to
        placeholder: enter slot
    
    cmd:
      type: string
      label: Command type
      required: true
      default: deploy
      ui:
        component: select
        options:
          - deploy
          - rollback
        tooltip: Type of operation to perform (deploy or rollback)
    
    deploy_type:
      type: string
      label: Deployment type
      required: true
      default: ${{(artifact.repositoryFormat == "" || artifact.repositoryFormat == "docker")? "CONTAINER":"ZIP"}}
      options:
        - ZIP
        - CONTAINER
      ui:
        component: select
        tooltip: Type of deployment (ZIP package or CONTAINER image)
    
    source:
      type: string
      label: Container source
      required: false
      default: ${{service.artifacts.primary.uses}}
      options:
        - docker-registry
        - acr
        - nexus3
        - artifactory
      ui:
        component: select
        tooltip: Source repository type for container image   
    
    subscription_id:
      type: string
      label: Subscription ID
      default: ${{infra.subscription}}
      required: true
      ui:
        tooltip: Azure subscription ID where function app is deployed
    
    resource_group:
      type: string
      label: Resource group
      required: true
      default: ${{infra.resourceGroup}}
      ui:
        tooltip: Azure resource group containing the function app

    image:
      type: string
      label: Container image
      required: false
      default: ${{artifact.metadata.image}}
      ui:
        tooltip: Name of the container image
    
    acr_name:
      type: string
      label: ACR registry name
      required: false
      default: ${{service.artifacts.primary.registry}}
      ui:
        tooltip: Name of the Azure Container Registry

    log_level:
      type: string
      label: Log level
      default: "info"
      options:
        - info
        - debug
        - warning
        - error
      ui:
        component: select
        tooltip: Log level for the plugin execution
    pre_cmd:
      type: string
      label: Pre execute command
      required: false
      ui:
        tooltip: Command to execute before plugin execution
        placeholder: echo "Pre Execute Command"
    env_vars:
      type: list
      label: Environment variables
      ui:
        component: key-value-pairs
        tooltip: Environment variables to pass to the plugin
    deploy_cmd:
      type: string
      label: Deploy Command Option
      required: false
      ui:
        component: text
        tooltip: Deploy command option
    
  layout:
    - artifact
    - deploy_type
    - infra
    - subscription_id
    - resource_group
    - app
    - slot
    - cmd
    - title: Optional Configuration
      items:
        - source
        - log_level
        - image
        - acr_name
        - pre_cmd
        - deploy_cmd
        - env_vars

  id: azureFunctionDeployStep
  name: Azure Function Deploy Step
  description: Deploying Azure Function.
  version: 1
  author: harness
  module:
    - cd
  alias: deploy
  step:
    group:
      steps:
        - if: ${{artifact.repositoryFormat != "" && artifact.repositoryFormat != "docker"}}
          name: Download Artifact
          id: DownloadArtifact
          run:
            container:
              image:  harnessdev/artifact-download-plugin:0.0.14
              connector: account.harnessImage
            env:
              PLUGIN_ARTIFACT_ID: ${{service.artifacts.primary.id}}
        - name: Azure Function  Step
          id: AzureFunctionDeployStep
          run:
            container:
              image: harnessdev/azure-function-plugin:0.0.1
              connector: account.harnessImage
            env:
              PLUGIN_LOG_LEVEL: ${{inputs.log_level}}
              PLUGIN_FUNCTION_NAME: ${{inputs.app}}
              PLUGIN_FUNCTION_SLOT: ${{inputs.slot}}
              PLUGIN_CMD_TYPE: deploy
              PLUGIN_DEPLOYMENT_TYPE: ${{inputs.deploy_type}}
              PLUGIN_ARTIFACT_TYPE: ${{inputs.source}}
              PLUGIN_SUBSCRIPTION_ID: ${{inputs.subscription_id}}
              PLUGIN_RESOURCE_GROUP: ${{inputs.resource_group}}        
              PLUGIN_CONTAINER_NAME: ${{inputs.image}} 
              PLUGIN_ACR_REGISTRY: ${{inputs.acr_name}}
              PLUGIN_PRE_EXECUTE_COMMAND: ${{inputs.pre_cmd}}
              PLUGIN_ARTIFACT_PATH: ${{${{runtime.fqn}}.DownloadArtifact.output.outputVariables.PLUGIN_ARTIFACT_DOWNLOAD_PATH}}
              PLUGIN_HARNESS_CONNECTOR: ${{inputs.infra}}
              PLUGIN_HARNESS_CONNECTOR: ${{inputs.artifact}}
              PLUGIN_DEPLOY_CMD_OPTION: ${{inputs.deploy_cmd}}
              PLUGIN_ENV_VARS: ${{inputs.env_vars}}