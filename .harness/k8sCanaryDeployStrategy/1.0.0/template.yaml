template:
  inputs:
    kubeconfig:
      type: string
      label: Kubeconfig Path
      default: ${{infra.PLUGIN_HARNESS_KUBE_CONFIG_PATH}}
      ui:
        tooltip: Enter the path to your kubeconfig file
    namespace:
      type: string
      label: Namespace
      default: ${{infra.namespace}}
      ui:
        tooltip: Enter the Kubernetes namespace for this deployment
    manifests:
      type: array
      label: Manifest Path
      default: ${{runtime.manifestPath}}
      ui:
        component: array
        input: 
          inputType: text
        tooltip: Enter the paths to your manifest files
    manifest_output_path:
      type: string
      label: Manifest Output Path
      ui:
        tooltip: Enter the directory path for the consolidated manifest output
        placeholder: path/manifest/output
    release:
      type: string
      label: Release Name
      default: ${{infra.release}}
      ui:
        tooltip: Enter the name for this Harness release
    service_id:
      type: string
      label: Service ID
      default: ${{service.identifier}}
      ui:
        tooltip: Enter the service identifier for this release
    environment_id:
      type: string
      label: Environment ID
      default: ${{env.identifier}}
      ui:
        tooltip: Enter the environment identifier for this release
    infra_id:
      type: string
      label: Infrastructure ID
      default: ${{infra.identifier}}
      ui:
        tooltip: Enter the infrastructure identifier for this release
    infra_key:
      type: string
      label: Infrastructure Key
      default: ${{infra.infrastructureKey}}
      ui:
        tooltip: Enter the infrastructure key for this release

    unit_type:
      type: string
      default: count
      label: Instances Unit Type
      options:
        - count
        - percentage
      ui:
        component: select
        tooltip: Select the unit type for instances (count or percentage)
    instances:
      type: number
      default: 1
      label: Instances
      ui:
        component: number
        tooltip: Enter the number of instances to deploy
    skip_resource_versioning:
      type: boolean
      label: Skip Resource Versioning
      default: false
      ui:
        component: boolean-card-select
        tooltip: Skip resource versioning
    skip_adding_track_selector:
      type: boolean
      label: Skip Adding Track Selector
      default: false
      ui:
        component: boolean-card-select
        tooltip: Enable this option to skip adding track selector to deployments

    skip_dry_run:
      type: boolean
      label: Skip Dry Run
      default: false
      ui:
        component: boolean-card-select
        tooltip: By default, Harness uses the --dry-run flag on the kubectl apply command, which prints the object that would be sent to the cluster without really sending it. If the Skip Dry Run option is selected, Harness will not use the --dry-run flag
    deploy_pruning:
      type: boolean
      label: Kubernetes Pruning
      default: false
      ui:
        component: boolean-card-select
        tooltip: Remove any resources that were present in an old manifest, but no longer present in the manifest used for the current deployment

    print_manifests:
      type: boolean
      label: Print Manifests
      default: false
      ui:
        component: boolean-card-select
        tooltip: Print the manifests that will be applied
    server_side_apply:
      type: boolean
      label: Server Side Apply
      default: false
      ui:
        component: boolean-card-select
        tooltip: Use server-side apply instead of client-side apply
    encrypt_yaml_output:
      type: boolean
      label: Encrypt YAML Output
      default: false
      ui:
        component: boolean-card-select
        tooltip: Encrypt the output YAML file
    deploy_flags:
      type: array
      label: Command Flags
      ui:
        component: list
        layout: grid
        inputs:
          - inputType: select
            relativePath: commandType
            label: Command Type
            inputConfig:
              options:
                - label: Apply
                  value: Apply
                - label: Describe
                  value: Describe
          - inputType: textarea
            relativePath: flag
            label: Flag
            ui:
              placeholder: --warnings-as-errors
    apply_timeout:
      type: string
      label: Apply command timeout
      default: 5m
      ui:
        tooltip: Enter the timeout for the apply command execution
    deploy_log_level:
      type: string
      label: Log Level
      default: info
      options:
        - warn
        - error
        - info
        - debug
        - trace
      ui:
        component: select
        tooltip:  Select the log level for deploy step
    
    skip_steady_state_check:
      type: boolean
      label: Skip Steady State Check
      default: false
      ui:
        component: boolean-card-select
        tooltip: Skip the steady state check
    describe_resources:
      type: boolean
      label: Describe Resources
      default: false
      ui:
        component: boolean-card-select
        tooltip: Flag to describe resources in the steady state check
        visible: ${{skipSteadyStateCheck == false}}
    steady_state_timeout:
      type: string
      label: Steady state command timeout
      default: 5m
      ui:
        tooltip: Enter the timeout for the steady state check
        visible: ${{skipSteadyStateCheck == false}}

    traffic_shift:
      type: boolean
      label: Use traffic shift
      default: false
      ui:
        component: boolean-card-select
        tooltip: Flag to enable traffic shift for canary deployment
    provider:
      type: string
      label: Provider
      default: istio
      options:
        - istio
        - k8s-native
      ui:
        component: select
        tooltip: Select the traffic shift provider
        visible: ${{trafficShift == true}}
    resource_name:
      type: string
      label: Resource Name
      default: traffic-split-${{service.name}}
      ui:
        tooltip: Enter the name of the Kubernetes resource (auto-generated if not provided)
        visible: ${{trafficShift == true}}
    hosts:
      type: array
      label: Hosts
      ui:
        component: array
        input: 
          inputType: text
        tooltip: Enter the comma separated list of host names
        placeholder: hostname
        visible: ${{trafficShift == true}}
    gateways:
      type: array
      label: Gateways
      ui:
        component: array
        input: 
          inputType: text
        tooltip: Enter the comma separated list of gateway names or fully qualified names
        placeholder: gateway name
        visible: ${{trafficShift == true}}
    routes:
      type: string
      label: Configure Routes
      ui:
        component: textarea
        tooltip: Enter the JSON string of the traffic shift routes configuration
        placeholder: '[{"name":"route1","destinations":[{"host":"svc","weight":60},{"host":"svc-canary","weight":40}]}]'
        visible: ${{trafficShift == true}}
    traffic_shift_timeout:
      type: string
      label: Traffic Shift command timeout
      default: 5m
      ui:
        tooltip: Enter the timeout for the traffic shift command
        visible: ${{trafficShift == true}}

    delete_namespaces:
      type: boolean
      label: Delete namespace resources
      default: false
      ui:
        component: boolean-card-select
        tooltip: Include namespace resources in deletion process
        visible: ${{selectDeleteResources == "release name"}}
    delete_flags:
      type: array
      label: Command Flags
      ui:
        component: list
        layout: grid
        inputs:
          - inputType: select
            relativePath: commandType
            label: Command Type
            inputConfig:
              options:
                - label: Delete
                  value: Delete
          - inputType: textarea
            relativePath: flag
            label: Flag
            ui:
              placeholder: --warnings-as-errors
    delete_log_level:
      type: string
      label: Log Level
      default: info
      options:
        - warn
        - error
        - info
        - debug
        - trace
      ui:
        component: select
        tooltip: Set the log level for the canary delete step

# Rolling Rollback
    rollback_delete_flags:
      type: array
      label: Command Flags
      ui:
        component: list
        layout: grid
        inputs:
          - inputType: select
            relativePath: commandType
            label: Command Type
            inputConfig:
              options:
                - label: Delete
                  value: Delete
          - inputType: textarea
            relativePath: flag
            label: Flag
            ui:
              placeholder: --warnings-as-errors
    rollback_delete_log_level:
      type: string
      label: Log Level
      default: info
      options:
        - warn
        - error
        - info
        - debug
        - trace
      ui:
        component: select
        tooltip: Set the log level for rollback canary delete step

    rollback_pruning:
      type: boolean
      label: Kubernetes Pruning
      default: false
      ui:
        component: boolean-card-select
        tooltip: Remove any resources that were present in an old manifest, but no longer present in the manifest used for the current deployment
    rollback_flags:
      type: array
      label: Command Flags
      ui:
        component: list
        layout: grid
        inputs:
          - inputType: select
            relativePath: commandType
            label: Command Type
            inputConfig:
              options:
                - label: Apply
                  value: Apply
                - label: Describe
                  value: Describe
                - label: Delete
                  value: Delete
          - inputType: textarea
            relativePath: flag
            label: Flag
            ui:
              placeholder: --warnings-as-errors
    rollback_log_level:
      type: string
      label: Log Level
      default: info
      options:
        - warn
        - error
        - info
        - debug
        - trace
      ui:
        component: select
        tooltip: Set the log level for the rollback step
  layout:
    - kubeconfig
    - namespace
    - manifests
    - unit_type
    - instances
    - title: Release Configuration
      items:
        - release
        - service_id
        - environment_id
        - infra_id
        - infra_key
    - title: Execution
      items:
        - title: Apply Configuration
          items:  
            - deploy_pruning
            - deploy_flags
            - skip_dry_run
            - print_manifests
            - server_side_apply
            - encrypt_yaml_output
            - apply_timeout
            - skip_steady_state_check
            - describe_resources
            - steady_state_timeout
        - title: Traffic Routing Configuration
          items:
            - traffic_shift
            - provider
            - resource_name
            - hosts
            - gateways
            - routes
            - traffic_shift_timeout
        - title: Canary Delete Configuration
          items:
            - delete_namespaces
            - delete_flags
            - delete_log_level
        - title: Optional Configuration
          items:
            - manifest_output_path
            - skip_resource_versioning
            - skip_adding_track_selector
            - deploy_log_level
    - title: Rollback
      items:
        - title: K8s Canary Rollback Delete
          items:
            - rollback_delete_flags
            - rollback_delete_log_level
        - title: K8s Rolling Rollback
          items:
            - rollback_flags
            - rollback_pruning
            - rollback_log_level
  id: k8sCanaryDeployStrategy
  name: K8s Canary Deploy Strategy
  description: Harness managed Canary kubernetes deployment with rollback
  version: 1
  author: harness
  module:
    - cd
  alias: deploy
  step:
    group:
      steps:
        - name: Kubernetes Canary Prepare
          id: k8sCanaryPrepare
          run:
            container:
              image: harnessdev/k8s-canary:0.0.1
              connector: account.harnessImage
            env:
              PLUGIN_KUBECONFIG_PATH: ${{inputs.kubeconfig}}
              PLUGIN_RELEASE_NAME: ${{inputs.release}}
              PLUGIN_SERVICE_ID: ${{inputs.service_id}}
              PLUGIN_ENVIRONMENT_ID: ${{inputs.environment_id}}
              PLUGIN_INFRA_ID: ${{inputs.infra_id}}
              PLUGIN_INFRA_KEY: ${{inputs.infra_key}}
              PLUGIN_MANIFEST_PATH: ${{inputs.manifests}}
              PLUGIN_MANIFEST_OUTPUT_PATH: ${{inputs.manifest_output_path}}
              PLUGIN_NAMESPACE: ${{inputs.namespace}}
              PLUGIN_INSTANCES_UNIT_TYPE: ${{inputs.unit_type}}
              PLUGIN_INSTANCES: ${{inputs.instances}}
              PLUGIN_SKIP_RESOURCE_VERSIONING: ${{inputs.skip_resource_versioning}}
              PLUGIN_FF_CDS_SUPPORT_HPA_AND_PDB_NG: ${{runtime.ff.CDS_SUPPORT_HPA_AND_PDB_NG}}
              PLUGIN_LOG_LEVEL: ${{inputs.deploy_log_level}}
        - name: Kubernetes Apply
          id: k8sApplyStep
          run:
            container:
              image: harnessdev/k8s-apply:0.0.1
              connector: account.harnessImage
            env:
              PLUGIN_KUBECONFIG_PATH: ${{inputs.kubeconfig}}
              PLUGIN_NAMESPACE: ${{inputs.namespace}}
              PLUGIN_MANIFEST_PATH: ${{${{runtime.fqn}}.k8sCanaryPrepare.output.outputVariables.PLUGIN_MANIFEST_OUTPUT_PATH}}
              PLUGIN_SKIP_DRY_RUN: ${{inputs.skip_dry_run}}
              PLUGIN_RELEASE_PRUNING_ENABLED: ${{inputs.deploy_pruning}}
              PLUGIN_SERVER_SIDE_APPLY: ${{inputs.server_side_apply}}
              PLUGIN_RELEASE_NAME: ${{inputs.release}}
              PLUGIN_RELEASE_NUMBER: ${{${{runtime.fqn}}.k8sCanaryPrepare.output.outputVariables.PLUGIN_RELEASE_NUMBER}}
              PLUGIN_SERVICE_ID: ${{inputs.service_id}}
              PLUGIN_ENVIRONMENT_ID: ${{inputs.environment_id}}
              PLUGIN_INFRA_ID: ${{inputs.infra_id}}
              PLUGIN_INFRA_KEY: ${{inputs.infra_key}}
              PLUGIN_PRINT_MANIFESTS: ${{inputs.print_manifests}}
              PLUGIN_ENCRYPT_YAML_OUTPUT: ${{inputs.encrypt_yaml_output}}
              PLUGIN_FLAGS_JSON: ${{json.format(${{inputs.deploy_flags}})}}
              PLUGIN_EXECUTE_DRY_RUN: false
              PLUGIN_LOG_LEVEL: ${{inputs.deploy_log_level}}
              PLUGIN_TIMEOUT: ${{inputs.apply_timeout}}
        - if: ${{inputs.skip_steady_state_check == false}}
          name: K8s Steady State Check Step
          id: k8sApplySteadyStateCheckStep
          template:
            uses: k8sSteadyStateCheckStep@1.0.0
            with:
              kubeconfig: ${{inputs.kubeconfig}}
              release: ${{inputs.release}}
              service_id: ${{inputs.service_id}}
              environment_id: ${{inputs.environment_id}}
              infra_id: ${{inputs.infra_id}}
              infra_key: ${{inputs.infra_key}}
              describe_resources: ${{inputs.describe_resources}}
              namespace: ${{inputs.namespace}}
              is_openshift: ${{${{runtime.fqn}}.k8sApplyStep.output.outputVariables.HARNESS_IS_OPENSHIFT}}
              existing_pods: ${{${{runtime.fqn}}.k8sApplyStep.output.outputVariables.PLUGIN_EXISTING_PODS}}
              release_number: ${{${{runtime.fqn}}.k8sApplyStep.output.outputVariables.PLUGIN_RELEASE_NUMBER}}
              custom_workloads: ${{${{runtime.fqn}}.k8sApplyStep.output.outputVariables.PLUGIN_CUSTOM_WORKLOADS}}
              managed_workloads: ${{${{runtime.fqn}}.k8sApplyStep.output.outputVariables.PLUGIN_MANAGED_WORKLOADS}}
              manifest: ${{${{runtime.fqn}}.k8sApplyStep.output.outputVariables.PLUGIN_MANIFEST_OUTPUT_FILE_PATH}}
              timeout: ${{inputs.steady_state_timeout}}
        - if: ${{inputs.traffic_shift == true}}
          name: K8s Traffic Shift 
          id: k8sTrafficShift
          template:
            uses: k8sTrafficRoutingStep@1.0.0
            with:
              kubeconfig: ${{inputs.kubeconfig}}
              provider: ${{inputs.provider}}
              config_type: new
              gateways: ${{inputs.gateways}}
              hosts: ${{inputs.hosts}}
              resource_name: ${{inputs.resource_name}}
              routes: ${{inputs.routes}}
              namespace: ${{inputs.namespace}}
              release: ${{inputs.release}}
              release_number: ${{${{runtime.fqn}}.k8sCanaryPrepare.output.outputVariables.PLUGIN_RELEASE_NUMBER}} 
              service_id: ${{inputs.service_id}}
              environment_id: ${{inputs.environment_id}}
              infra_id: ${{inputs.infra_id}}
              infra_key: ${{inputs.infra_key}}
              server_side_apply: ${{inputs.server_side_apply}}
              prepare_only: false
              manifest_output_path: ${{inputs.manifest_output_path}}
              timeout: ${{inputs.traffic_shift_timeout}}
              is_openshift: ${{${{runtime.fqn}}.k8sApplyStep.output.outputVariables.HARNESS_IS_OPENSHIFT}}
              log_level: ${{inputs.deploy_log_level}}
        - name: K8s Canary Delete Step
          id: k8sCanaryDeleteStep
          template:
            uses: k8sCanaryDeleteStep@1.0.0
            with:
              kubeconfig: ${{inputs.kubeconfig}}
              resources: ${{${{runtime.fqn}}.k8sCanaryPrepare.output.outputVariables.PLUGIN_CANARY_WORKLOADS}}
              namespace: ${{inputs.namespace}}
              flags: ${{inputs.delete_flags}}
              log_level: ${{inputs.delete_log_level}}
              is_openshift: ${{${{runtime.fqn}}.k8sApplyStep.output.outputVariables.HARNESS_IS_OPENSHIFT}}
        - name: K8s Rolling Deploy Step
          id: k8sRollingDeployStep
          template:
            uses: k8sRollingDeployStep@1.0.0
            with:
              kubeconfig: ${{inputs.kubeconfig}}
              namespace: ${{inputs.namespace}}
              manifests: ${{inputs.manifests}}
              manifest_output_path: ${{inputs.manifest_output_path}}
              release: ${{inputs.release}}
              service_id: ${{inputs.service_id}}
              environment_id: ${{inputs.environment_id}}
              infra_id: ${{inputs.infra_id}}
              infra_key: ${{inputs.infra_key}}
              skip_resource_versioning: ${{inputs.skip_resource_versioning}}
              skip_adding_track_selector: ${{inputs.skip_adding_track_selector}}
              skip_dry_run: ${{inputs.skip_dry_run}}
              pruning: ${{inputs.deploy_pruning}}
              print_manifests: ${{inputs.print_manifests}}
              server_side_apply: ${{inputs.server_side_apply}}
              encrypt_yaml_output: ${{inputs.encrypt_yaml_output}}
              flags: ${{inputs.deploy_flags}}
              apply_timeout: ${{inputs.apply_timeout}}
              log_level: ${{inputs.deploy_log_level}}
              skip_steady_state_check: ${{inputs.skip_steady_state_check}}
              describe_resources: ${{inputs.describe_resources}}
              steady_state_timeout: ${{inputs.steady_state_timeout}}
      rollback:
        group:
          steps:
            - name: K8s Canary Rollback Delete Step
              id: k8sCanaryRollbackDeleteStep
              template: 
                uses: k8sCanaryDeleteStep@1.0.0
                with:
                  select_delete_resources: resources
                  kubeconfig: ${{inputs.kubeconfig}}
                  resources: ${{rollback.PLUGIN_CANARY_WORKLOADS}}
                  namespace: ${{rollback.PLUGIN_NAMESPACE}}
                  flags: ${{inputs.rollback_delete_flags}}
                  log_level: ${{inputs.rollback_delete_log_level}}
                  is_openshift: ${{rollback.HARNESS_IS_OPENSHIFT}}
            - name: K8s Rolling Rollback Step
              id: k8sRollingRollbackStep
              template:
                uses: k8sRollingRollbackStep@1.0.0
                with:
                  kubeconfig: ${{inputs.kubeconfig}}
                  namespace: ${{rollback.PLUGIN_NAMESPACE}}
                  release: ${{rollback.PLUGIN_RELEASE_NAME}}
                  pruning: ${{inputs.rollback_pruning}}
                  flags: ${{inputs.rollback_flags}}
                  steady_state_timeout: ${{inputs.steady_state_timeout}}
                  log_level: ${{inputs.rollback_log_level}}
                  skip_steady_state_check: ${{inputs.skip_steady_state_check}}
                  describe_resources: ${{inputs.describe_resources}}
                  apply_timeout: ${{inputs.apply_timeout}}
      on-failure:
        errors: all
        action: stage-rollback