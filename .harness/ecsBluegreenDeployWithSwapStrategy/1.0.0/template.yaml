template:
  inputs:
    connector:
      type: connector
      label: AWS connector
      required: true
      default: ${{infra.connector}}
      oneof:
        - Aws
      ui:
        tooltip: The Harness AWS Connector for the AWS account where you want perform ECS Bluegreen deployment
        placeholder: Select AWS Connector
    cluster:
      type: string
      label: Cluster
      required: true
      default: ${{infra.cluster}}
      ui:
        component: string
        tooltip: The AWS cluster
    region:
      type: string
      label: Region
      required: true
      default: ${{infra.region}}
      ui:
        component: string
        placeholder: us-east-1
        tooltip: The AWS region
    deploy_log_level:
      type: string
      label: Log level for deploy
      default: info
      options:
        - warn
        - error
        - info
        - debug
        - trace
      ui:
        component: select
        tooltip: Set the log level for the deploy step
    task_def_mode:
      type: string
      label: Task definition
      default: Task Definition
      required: true
      options:
        - Task Definition
        - Task Definition ARN
      ui:
        component: select
    task_def:
      type: string
      label: ECS task definition
      required: true
      default: ${{service.manifests.taskDefinition.paths}}
      ui:
        component: string
        tooltip: Path to the file containing task definition
        placeholder: /path/to/file
        visible: ${{taskDefMode == 'Task Definition'}}
    task_def_arn:
      type: string
      label: ECS task definition ARN
      required: true
      default: ${{service.taskArn}}
      ui:
        component: string
        tooltip: ARN value of task definition
        placeholder: Enter task definition ARN
        visible: ${{taskDefMode == 'Task Definition ARN'}}
    service_def:
      type: string
      label: ECS service definition
      required: true
      default: ${{service.manifests.serviceDefinition.paths}}
      ui:
        component: string
        tooltip: Path to the file containing service definition
        placeholder: /path/to/file
    scalable_targets:
      type: array
      label: ECS scalable targets
      default: ${{service.manifests.scalableTarget.paths}}
      ui:
        component: array
        input:
          inputType: text
        tooltip: Path to the file(s) containing scalable target definition
        placeholder: /path/to/file
    scaling_policies:
      type: array
      label: ECS scaling policies
      default: ${{service.manifests.scalingPolicy.paths}}
      ui:
        component: array
        input:
          inputType: text
        tooltip: Path to the file(s) containing scaling policies definition
        placeholder: /path/to/file
    target_group_arn_key:
      type: string
      label: ECS target group ARN key (placeholder)
      default: <+targetGroupArn>
      ui:
        component: string
        tooltip: Placeholder for target group ARN value
    remove_autoscaling_blue_svc:
      type: boolean
      label: Enable Auto Scaling In Swap Step
      default: false
      ui:
        component: boolean-card-select
        tooltip: Remove autoscaling config from blue service
        visible: ${{trafficShift == false}}
    update_green_svc:
      type: boolean
      label: Update green service
      default: false
      ui:
        component: boolean-card-select
        tooltip: Update green service instead of deleting it
    deploy_skip_steady_state:
      type: boolean
      label: Skip steady state check for deploy step
      default: false
      ui:
        component: boolean-card-select
        tooltip: Turn on to skip steady state check for deploy step
    deploy_steady_state_timeout:
      type: string
      label: Steady state check command timeout for deploy step
      default: 10m
      ui:
        tooltip: Timeout to use during steady state check process for deploy step
        visible: ${deploySkipSteadyState == false}}
    load_balancer:
      type: string
      label: Elastic Load balancer
      required: true
      ui:
        tooltip: Elastic Load balancer
        placeholder: Please enter load balancer name
    traffic_shift:
      type: boolean
      label: Use Shift Traffic
      default: false
      ui:
        component: boolean-card-select
        tooltip: Enable this checkbox to activate traffic shifting for the ECS Blue Green deployment. When selected, traffic will be gradually shifted between target groups based on the weight percentages you define. If not selected, the deployment will follow the standard Blue Green process, swapping traffic 100% between the production and stage target groups.
    prod_listener_arn:
      type: string
      label: Prod listener
      required: true
      ui:
        tooltip: Select the ELB listener that you want to use as the Prod Listener.
        placeholder: Please enter ARN of Prod listener
    prod_listener_rule_arn:
      type: string
      label: Prod listener rule ARN
      ui:
        tooltip: If you do not enter a listener rule, Harness uses the Default rule.
        placeholder: Please enter ARN of Prod listener rule
    stage_listener_arn:
      type: string
      label: Stage listener
      required: true
      ui:
        tooltip: Select the ELB listener that you want to use as the Stage Listener.
        placeholder: Please enter ARN of Stage listener
        visible: ${{trafficShift == false}}
    stage_listener_rule_arn:
      type: string
      label: Stage listener rule ARN
      ui:
        tooltip: If you do not enter a listener rule, Harness uses the Default rule.
        placeholder: Please enter ARN of Stage listener rule
        visible: ${{trafficShift == false}}
    stage_target_group_arn:
      type: string
      label: Stage Target Group ARN
      ui:
        tooltip: Select the target group where the new service version will be deployed.
        placeholder: Please enter Stage Target Group ARN
        visible: ${{trafficShift == true}}
    swap_log_level:
      type: string
      label: Log level for swap
      default: info
      options:
        - warn
        - error
        - info
        - debug
        - trace
      ui:
        component: select
        tooltip: Set the log level for the swap step
    swap_not_downsize_old:
      type: boolean
      label: Do not downsize old service
      default: false
      ui:
        component: boolean-card-select
        tooltip: Use this setting to choose whether to downsize the older, previous version of the service. By default, the previous service is downsized to 0. The service is downsized, but not deleted. If the older service needs to be brought back up again, it is still available.
    swap_downsize_delay:
      type: string
      label: Downsize Old Service Delay
      default: 10s
      ui:
        tooltip: Delay before downsizing old service
        visible: ${{swapDoNotDownsizeOld == false}}
    swap_skip_steady_state:
      type: boolean
      label: Skip steady state check for swap step
      default: false
      ui:
        component: boolean-card-select
        tooltip: Turn on to skip steady state check for swap step
    swap_steady_state_timeout:
      type: string
      label: Steady state check command timeout for swap step
      default: 10m
      ui:
        tooltip: Timeout to use during steady state check process for swap step
        visible: ${{swapSkipSteadyState == false}}
    rollback_log_level:
      type: string
      label: Log level for rollback
      default: info
      options:
        - warn
        - error
        - info
        - debug
        - trace
      ui:
        component: select
        tooltip: Set the log level for the rollback step
    rollback_skip_steady_state:
      type: boolean
      label: Skip steady state check for deploy rollback step
      default: false
      ui:
        component: boolean-card-select
        tooltip: Turn on to skip steady state check for deploy rollback step
    rollback_steady_state_timeout:
      type: string
      label: Steady state check command timeout for rollback step
      default: 10m
      ui:
        tooltip: Timeout to use during steady state check process for rollback step
        visible: ${{swapRollbackSteadyState == false}}
  layout: 
    - connector
    - title: Infra Configuration
      items:
        - region
        - cluster
    - title: Manifest Configuration
      items:
        - task_def_mode
        - task_def
        - task_def_arn
        - service_def
        - title: Optional
          items:
            - scalable_targets
            - scaling_policies
    - title: Elastic Load Balancer Configuration
      items:
        - load_balancer
        - traffic_shift
        - prod_listener_arn
        - prod_listener_rule_arn
        - stage_listener_arn
        - stage_listener_rule_arn
        - stage_target_group_arn
    - title: Optional Configuration
      items:
        - target_group_arn_key
        - remove_autoscaling_blue_svc
        - update_green_svc
        - deploy_log_level
        - deploy_skip_steady_state
        - deploy_steady_state_timeout
        - swap_log_level
        - swap_not_downsize_old
        - swap_downsize_delay
        - swap_skip_steady_state
        - swap_steady_state_timeout
        - rollback_log_level
        - rollback_skip_steady_state
        - rollback_steady_state_timeout
  id: ecsBluegreenDeployWithSwapStrategy
  name: ECS BlueGreen Deploy With Swap Strategy
  description: Executes an ECS BlueGreen deployment with swap of target groups
  version: 1
  author: harness
  module:
    - cd
  alias: bg-deploy-with-swap
  step:
    group:
      steps:
        - name: bluegreendeploy
          id: bluegreendeploystep
          template:
            uses: ecsBluegreenDeployStep@1.0.0
            with:
              connector: ${{inputs.connector}}
              log_level: ${{inputs.deploy_log_level}}
              cluster: ${{inputs.cluster}}
              region: ${{inputs.region}}
              task_def: ${{inputs.task_def}}
              service_def: ${{inputs.service_def}}
              scalable_targets: ${{inputs.scalable_targets}}
              scaling_policies: ${{inputs.scaling_policies}}
              task_def_arn: ${{inputs.task_def_arn}}
              target_group_arn_key: ${{inputs.target_group_arn_key}}
              remove_autoscaling_blue_svc: ${{inputs.remove_autoscaling_blue_svc}}
              update_green_svc:  ${{inputs.update_green_svc}}
              skip_steady_state: ${{inputs.deploy_skip_steady_state}}
              steady_state_timeout: ${{inputs.deploy_steady_state_timeout}}
              load_balancer: ${{inputs.load_balancer}}
              traffic_shift: ${{inputs.traffic_shift}}
              prod_listener_arn: ${{inputs.prod_listener_arn}}
              prod_listener_rule_arn: ${{inputs.prod_listener_rule_arn}}
              stage_listener_arn: ${{inputs.stage_listener_arn}}
              stage_listener_rule_arn: ${{inputs.stage_listener_rule_arn}}
              stage_target_group_arn: ${{inputs.stage_target_group_arn}}
        - name: bluegreenswap
          id: bluegreenswapstep
          template:
            uses: ecsBluegreenSwapTargetGroupsStep@1.0.0
            with:
              connector: ${{inputs.connector}}
              log_level: ${{inputs.swap_log_level}}
              cluster: ${{inputs.cluster}}
              region: ${{inputs.region}}
              blue_service: ${{${{runtime.fqn}}.bluegreendeploystep.output.outputVariables.SERVICE_NAME}}
              green_service: ${{${{runtime.fqn}}.bluegreendeploystep.output.outputVariables.GREEN_SERVICE_NAME}}
              first_deployment: ${{${{runtime.fqn}}.bluegreendeploystep.output.outputVariables.FIRST_DEPLOYMENT}}
              not_downsize_old: ${{inputs.swap_not_downsize_old}}
              downsize_delay: ${{inputs.swap_downsize_delay}}
              scalable_targets: ${{inputs.scalable_targets}}
              scaling_policies: ${{inputs.scaling_policies}}
              skip_steady_state: ${{inputs.swap_skip_steady_state}}
              steady_state_timeout: ${{inputs.swap_steady_state_timeout}}
              load_balancer: ${{${{runtime.fqn}}.bluegreendeploystep.output.outputVariables.LOAD_BALANCER}}
              stage_listener_arn: ${{${{runtime.fqn}}.bluegreendeploystep.output.outputVariables.STAGE_LISTENER_ARN}}
              stage_listener_rule_arn: ${{${{runtime.fqn}}.bluegreendeploystep.output.outputVariables.STAGE_LISTENER_RULE_ARN}}
              stage_target_group_arn: ${{${{runtime.fqn}}.bluegreendeploystep.output.outputVariables.STAGE_TARGET_GROUP_ARN}}
              prod_listener_arn: ${{${{runtime.fqn}}.bluegreendeploystep.output.outputVariables.PROD_LISTENER_ARN}}
              prod_listener_rule_arn: ${{${{runtime.fqn}}.bluegreendeploystep.output.outputVariables.PROD_LISTENER_RULE_ARN}}
              prod_target_group_arn: ${{${{runtime.fqn}}.bluegreendeploystep.output.outputVariables.PROD_TARGET_GROUP_ARN}}
      rollback:
        - name: bluegreenrollback
          id: bluegreenrollbackstep
          template:
            uses: ecsBluegreenRollbackStep@1.0.0
            with:
              connector: ${{inputs.connector}}
              log_level: ${{inputs.rollback_log_level}}
              cluster: ${{inputs.cluster}}
              region: ${{inputs.region}}
              blue_service: ${{rollback.data.SERVICE_NAME}}
              green_service: ${{rollback.data.GREEN_SERVICE_NAME}}
              first_deployment: ${{rollback.data.FIRST_DEPLOYMENT}}
              new_service_created: ${{rollback.data.NEW_SERVICE_CREATED}}
              traffic_shift_started: ${{rollback.data.TRAFFIC_SHIFT_STARTED}}
              blue_service_json: ${{rollback.data.SERVICE_JSON}}
              blue_service_scalable_targets_json: ${{rollback.data.SCALABLE_TARGETS_JSON}}
              blue_service_scaling_policies_json: ${{rollback.data.SCALING_POLICIES_JSON}}
              green_service_json: ${{rollback.data.GREEN_SERVICE_JSON}}
              green_service_scalable_targets_json: ${{rollback.data.GREEN_SERVICE_SCALABLE_TARGETS_JSON}}
              green_service_scaling_policies_json: ${{rollback.data.GREEN_SERVICE_SCALING_POLICIES_JSON}}
              green_service_existed: ${{rollback.data.GREEN_SERVICE_EXIST}}
              rollback_green_service: ${{rollback.data.GREEN_SERVICE_ROLLBACK_DATA_EXIST}}
              skip_steady_state: ${{inputs.rollback_skip_steady_state}}
              steady_state_timeout: ${{inputs.rollback_steady_state_timeout}}
              load_balancer: ${{rollback.data.LOAD_BALANCER}}
              stage_listener_arn: ${{rollback.data.STAGE_LISTENER_ARN}}
              stage_listener_rule_arn: ${{rollback.data.STAGE_LISTENER_RULE_ARN}}
              stage_target_group_arn: ${{rollback.data.STAGE_TARGET_GROUP_ARN}}
              prod_listener_arn: ${{rollback.data.PROD_LISTENER_ARN}}
              prod_listener_rule_arn: ${{rollback.data.PROD_LISTENER_RULE_ARN}}
              prod_target_group_arn: ${{rollback.data.PROD_TARGET_GROUP_ARN}}
              traffic_shift: ${{rollback.data.IS_TRAFFIC_SHIFT}}
      on-failure:
        errors: all
        action: stage-rollback